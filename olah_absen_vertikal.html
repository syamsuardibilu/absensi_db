<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Olah Absensi — Tampilan Vertikal</title>
    <style>
      :root {
        --bg: #0b1320; /* gelap elegan */
        --panel: #121a2b;
        --muted: #9fb0d4;
        --text: #e8eeff;
        --accent: #6aa3ff;
        --chip: #1b2640;
        --border: #24314f;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        height: 100%;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: saturate(1.2) blur(6px);
        background: linear-gradient(
          180deg,
          rgba(11, 19, 32, 0.95),
          rgba(11, 19, 32, 0.7)
        );
        border-bottom: 1px solid var(--border);
      }
      .wrap {
        max-width: 1100px;
        margin: auto;
        padding: 16px;
      }
      h1 {
        font-size: clamp(18px, 2.2vw, 22px);
        margin: 0 0 8px 0;
      }
      .bar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .bar > * {
        height: 40px;
      }
      input[type="text"],
      select {
        background: var(--chip);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        padding: 0 12px;
        outline: none;
        width: 100%;
        min-width: 220px;
      }
      .btn {
        background: var(--accent);
        border: 0;
        color: #071022;
        border-radius: 10px;
        padding: 0 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .chips {
        display: flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 14px;
      }
      .chip {
        background: var(--chip);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 10px;
      }
      main {
        padding: 20px 0 60px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 14px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 1px 0 rgba(255, 255, 255, 0.04) inset;
      }
      .row-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .row-title {
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .dl {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 6px 12px;
      }
      .dt {
        color: var(--muted);
      }
      .dd {
        word-break: break-word;
      }
      .hr {
        height: 1px;
        background: var(--border);
        margin: 10px 0;
      }
      .empty {
        opacity: 0.7;
        font-style: italic;
      }
      .foot {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
        margin-top: 18px;
      }
      .pagination {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .pagination button {
        height: 36px;
        padding: 0 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--chip);
        color: var(--text);
        cursor: pointer;
      }
      .pagination button[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .loading,
      .error {
        border: 1px dashed var(--border);
        background: var(--chip);
        border-radius: 12px;
        padding: 14px;
        color: var(--muted);
      }
      .kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        background: #0d1526;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 2px 6px;
      }
      .pill {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #0f1a31;
        color: var(--muted);
        border: 1px solid var(--border);
      }

      /* Compact mode */
      .compact .card {
        padding: 10px;
      }
      .compact .dl {
        grid-template-columns: 120px 1fr;
        gap: 4px 8px;
      }
      .compact .row-title {
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>
          Tabel <span class="pill">absensi_db.olah_absensi</span> — Tampilan
          Vertikal
        </h1>
        <div class="bar">
          <input
            id="search"
            type="text"
            placeholder="Cari teks di semua kolom… (mis. perner, tanggal, dll)"
          />
          <select id="pageSize">
            <option value="12">12 / halaman</option>
            <option value="24" selected>24 / halaman</option>
            <option value="48">48 / halaman</option>
            <option value="100">100 / halaman</option>
            <option value="999999">Semua</option>
          </select>
          <label
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              color: var(--muted);
            "
            ><input id="compact" type="checkbox" /> Compact</label
          >
          <button class="btn" id="reload">Muat Ulang</button>
        </div>
        <div class="chips" id="meta"></div>
      </div>
    </header>

    <main class="wrap" id="app">
      <div class="loading">Memuat data…</div>
    </main>

    <script>
      /**
       * ────────────────────────────────────────────────────────────────────────────────
       * KONFIGURASI ENDPOINT API
       * ────────────────────────────────────────────────────────────────────────────────
       * Secara default memakai same-origin: `${location.origin}/getAllData`
       * Ubah API_PATH bila endpoint Anda berbeda (mis. '/olah-absensi/all').
       * Bila server lokal: pastikan CORS diaktifkan atau buka file ini dari host yang sama.
       */
      const API_PATH = "/getAllData"; // sesuaikan dengan server Anda

      // Pakai window.BASE_URL bila disediakan di halaman, selain itu same-origin
      const BASE_URL =
        (window.BASE_URL && window.BASE_URL.trim()) || location.origin;
      const ENDPOINT = `${BASE_URL}${API_PATH}`;

      // Urutan kolom opsional; biarkan array kosong untuk mengikuti urutan objek dari server
      const COLUMN_ORDER = [
        // 'perner','nip','nama','tanggal','daily_in','daily_out','status_absen','status_jam_kerja'
      ];

      // State
      let RAW = []; // data asli dari server
      let FILTERED = []; // setelah pencarian
      let page = 1; // halaman saat ini
      let pageSize = 24; // ukuran halaman

      const dom = {
        app: document.getElementById("app"),
        meta: document.getElementById("meta"),
        search: document.getElementById("search"),
        pageSize: document.getElementById("pageSize"),
        compact: document.getElementById("compact"),
        reload: document.getElementById("reload"),
      };

      function fmtValue(v) {
        if (v === null || v === undefined)
          return '<span class="empty">—</span>';
        if (typeof v === "boolean") return v ? "true" : "false";

        if (typeof v === "string") {
          const s = v.trim();
          // YYYY-MM-DD -> DD/MM/YYYY
          if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
            const [y, m, d] = s.split("-");
            return `${d}/${m}/${y}`;
          }
          // ISO DateTime -> lokal
          if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s)) {
            const dt = new Date(s);
            if (!isNaN(dt)) return dt.toLocaleString();
          }
          return s.length ? escapeHtml(s) : '<span class="empty">—</span>';
        }

        if (typeof v === "number") {
          // tampilkan integer apa adanya, desimal dengan 2 digit
          return Number.isInteger(v) ? String(v) : v.toFixed(2);
        }

        // objek / array -> JSON ringkas
        try {
          return "<code>" + escapeHtml(JSON.stringify(v)) + "</code>";
        } catch (_) {}
        return String(v);
      }

      function escapeHtml(s) {
        return s
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function deriveColumns(rows) {
        if (!rows.length) return [];
        const set = new Set();
        // ikuti COLUMN_ORDER bila diset; lalu sisanya
        COLUMN_ORDER.forEach((c) => set.add(c));
        rows.forEach((r) => Object.keys(r).forEach((k) => set.add(k)));
        return Array.from(set).filter(Boolean);
      }

      function render() {
        const total = FILTERED.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (page > totalPages) page = totalPages;

        const start = (page - 1) * pageSize;
        const end = Math.min(total, start + pageSize);
        const slice = FILTERED.slice(start, end);

        const cols = deriveColumns(
          slice.length ? slice : FILTERED.length ? FILTERED : RAW
        );

        const cards = slice
          .map((row, idx) => {
            const num = start + idx + 1;
            const dl = cols
              .map(
                (k) => `
        <div class="dt">${escapeHtml(k)} :</div>
        <div class="dd">${fmtValue(row[k])}</div>
      `
              )
              .join("");
            return `
        <article class="card">
          <div class="row-head">
            <div class="row-title">No. ${num}</div>
          </div>
          <div class="dl">${dl}</div>
        </article>
      `;
          })
          .join("");

        dom.app.innerHTML = `
      ${!total ? `<div class="loading">Tidak ada data yang cocok.</div>` : ""}
      <section class="grid">${cards}</section>
      <div class="foot">
        <div class="chips">
          <span class="chip">Total baris: ${total.toLocaleString(
            "id-ID"
          )}</span>
          <span class="chip">Halaman: ${page} / ${totalPages}</span>
          <span class="chip">Menampilkan: ${slice.length} item</span>
          <span class="chip">Endpoint: <span class="kbd">${ENDPOINT}</span></span>
        </div>
        <nav class="pagination">
          <button ${page === 1 ? "disabled" : ""} data-act="first">⏮︎</button>
          <button ${page === 1 ? "disabled" : ""} data-act="prev">◀︎</button>
          <button ${
            page === totalPages ? "disabled" : ""
          } data-act="next">▶︎</button>
          <button ${
            page === totalPages ? "disabled" : ""
          } data-act="last">⏭︎</button>
        </nav>
      </div>
    `;

        const nav = dom.app.querySelector(".pagination");
        if (nav) {
          nav.addEventListener("click", (e) => {
            const act = e.target.getAttribute("data-act");
            if (!act) return;
            if (act === "first") page = 1;
            if (act === "prev") page = Math.max(1, page - 1);
            if (act === "next") page = Math.min(totalPages, page + 1);
            if (act === "last") page = totalPages;
            render();
          });
        }
      }

      function applySearch() {
        const q = dom.search.value.trim().toLowerCase();
        if (!q) {
          FILTERED = RAW.slice();
          page = 1;
          return;
        }
        FILTERED = RAW.filter((row) => {
          for (const k in row) {
            const v = row[k];
            if (v === null || v === undefined) continue;
            const s = typeof v === "string" ? v : JSON.stringify(v);
            if ((s + " " + k).toLowerCase().includes(q)) return true;
          }
          return false;
        });
        page = 1;
      }

      function setMeta(msg) {
        dom.meta.innerHTML = `<span class="chip">${msg}</span>`;
      }

      async function load() {
        dom.app.innerHTML = `<div class="loading">Memuat data dari <span class="kbd">${ENDPOINT}</span>…</div>`;
        setMeta("Mencoba memuat data…");
        const t0 = performance.now();
        try {
          const res = await fetch(ENDPOINT, {
            headers: { Accept: "application/json" },
          });
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          const data = await res.json();
          // Deteksi bentuk hasil: {data:[...]} atau [...]
          const rows = Array.isArray(data)
            ? data
            : Array.isArray(data.data)
            ? data.data
            : [];
          if (!Array.isArray(rows))
            throw new Error("Format respons tidak dikenali");
          RAW = rows;
          FILTERED = rows.slice();
          page = 1;
          const ms = Math.round(performance.now() - t0);
          setMeta(`Loaded ${rows.length} baris dalam ${ms} ms`);
          render();
        } catch (err) {
          dom.app.innerHTML = `<div class="error">Gagal memuat data: ${escapeHtml(
            err.message
          )}<br>Pastikan endpoint benar, server berjalan, dan CORS diizinkan.</div>`;
          setMeta("Gagal memuat data");
          console.error(err);
        }
      }

      // Event handlers
      dom.pageSize.addEventListener("change", () => {
        pageSize = parseInt(dom.pageSize.value, 10);
        page = 1;
        render();
      });
      dom.reload.addEventListener("click", load);
      dom.compact.addEventListener("change", () => {
        document.body.classList.toggle("compact", dom.compact.checked);
      });

      // Debounce pencarian
      let timer = null;
      dom.search.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          applySearch();
          render();
        }, 200);
      });

      // Inisialisasi
      load();
    </script>
  </body>
</html>

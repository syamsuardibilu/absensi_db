<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Rekap Absensi Karyawan</title>

    <!-- SheetJS Library untuk Export Excel XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 10px;
      }

      .header p {
        color: #7f8c8d;
        text-align: center;
        font-size: 1.1rem;
      }

      .controls {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(17, 153, 142, 0.6);
      }

      .btn-download {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
      }

      .btn-download:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .search-box {
        flex: 1;
        min-width: 250px;
      }

      .search-box input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
      }

      .search-box input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .stats {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        display: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-card h3 {
        font-size: 0.9rem;
        margin-bottom: 8px;
        opacity: 0.9;
      }

      .stat-card p {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .table-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
      }

      .table-scroll-wrapper {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 600px;
        position: relative;
        scrollbar-width: thin;
        scrollbar-color: #667eea #f1f1f1;

        /* Offset untuk sticky multi-row header */
        --header-row-1: 0px;
        --header-row-2: 40px;
      }

      .table-scroll-wrapper::-webkit-scrollbar {
        height: 12px;
        width: 12px;
      }

      .table-scroll-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
      }

      .table-scroll-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
      }

      .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      }

      /* Scroll indicator */
      .scroll-indicator {
        position: absolute;
        top: 10px;
        right: 20px;
        background: rgba(102, 126, 234, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 150;
        animation: fadeInOut 3s ease-in-out;
      }

      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        min-width: 2400px; /* Increased min-width for more columns */
      }

      th,
      td {
        border: 1px solid #e1e8ed;
        padding: 12px 8px;
        text-align: center;
        white-space: nowrap;
      }

      /* Sticky header */
      thead th {
        position: sticky;
        z-index: 100;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        font-weight: 600;
        font-size: 10px;
      }

      /* Main header row (grup utama) */
      thead tr.main-header th {
        top: var(--header-row-1);
        z-index: 102;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        font-size: 9px;
        padding: 8px 4px;
      }

      /* Sub header row (detail kolom) */
      thead tr.sub-header th {
        top: calc(var(--header-row-1) + var(--header-row-2));
        z-index: 101;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      tbody tr:nth-child(even) {
        background: rgba(102, 126, 234, 0.05);
      }

      tbody tr:hover {
        background: rgba(102, 126, 234, 0.15);
        transform: scale(1.001);
        transition: all 0.2s ease;
      }

      /* PERNER, NIP, dan NAMA yang sticky kiri */
      .sticky-left-1 {
        position: sticky;
        left: 0;
        z-index: 90;
        background: rgba(102, 126, 234, 0.2);
        font-weight: 700;
        min-width: 100px;
        max-width: 100px;
      }

      .sticky-left-2 {
        position: sticky;
        left: 100px; /* Tepat setelah PERNER (100px) */
        z-index: 90;
        background: rgba(102, 126, 234, 0.18);
        font-weight: 600;
        min-width: 100px;
        max-width: 100px;
      }

      .sticky-left-3 {
        position: sticky;
        left: 200px; /* Tepat setelah PERNER + NIP (200px) */
        z-index: 90;
        background: rgba(102, 126, 234, 0.15);
        font-weight: 600;
        min-width: 120px;
        max-width: 120px;
      }

      /* BIDANG/UNIT tidak sticky - normal column */
      .bidang-unit {
        font-weight: 600;
        background: rgba(102, 126, 234, 0.05);
        min-width: 120px;
      }

      .percentage {
        font-weight: 600;
      }

      .percentage.high {
        color: #27ae60;
        background: rgba(39, 174, 96, 0.1);
        border-radius: 6px;
      }

      .percentage.medium {
        color: #f39c12;
        background: rgba(243, 156, 18, 0.1);
        border-radius: 6px;
      }

      .percentage.low {
        color: #e74c3c;
        background: rgba(231, 76, 60, 0.1);
        border-radius: 6px;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .alert-success {
        background: rgba(39, 174, 96, 0.1);
        color: #27ae60;
        border: 2px solid rgba(39, 174, 96, 0.2);
      }

      .alert-error {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
        border: 2px solid rgba(231, 76, 60, 0.2);
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        margin-top: 15px;
        border-radius: 12px;
        flex-wrap: wrap;
      }

      .pagination-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
        font-size: 13px;
        color: #2c3e50;
        min-width: 200px;
      }

      .pagination-info .primary-info {
        font-weight: 600;
        font-size: 14px;
      }

      .pagination-info .secondary-info {
        font-size: 12px;
        color: #7f8c8d;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .pagination-navigation {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pagination button {
        padding: 8px 16px;
        border: 2px solid #e1e8ed;
        background: white;
        color: #2c3e50;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        min-width: 40px;
      }

      .pagination button:hover:not(:disabled) {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination .active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .page-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #2c3e50;
      }

      .page-input {
        width: 60px;
        padding: 6px 8px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        text-align: center;
        font-size: 13px;
        background: white;
      }

      .page-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
      }

      .items-per-page-group {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #2c3e50;
      }

      .items-per-page-select {
        padding: 6px 8px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        background: white;
        font-size: 13px;
        cursor: pointer;
      }

      .items-per-page-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
      }

      .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #7f8c8d;
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
      }

      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .search-box {
          min-width: auto;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .pagination {
          flex-direction: column;
          gap: 15px;
        }

        .pagination-controls {
          flex-direction: column;
          gap: 10px;
          width: 100%;
        }

        .pagination-navigation {
          justify-content: center;
          flex-wrap: wrap;
        }

        .page-input-group,
        .items-per-page-group {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Header -->
      <div class="header">
        <h1>📊 Dashboard Rekap Absensi</h1>
        <p>Sistem Monitoring dan Analisis Kehadiran Karyawan</p>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button id="generateBtn" class="btn btn-primary">
          <span>⚡</span> Generate Rekap Absensi
        </button>
        <button id="refreshBtn" class="btn btn-secondary">
          <span>🔄</span> Refresh Data
        </button>
        <button id="downloadBtn" class="btn btn-download" disabled>
          <span>📊</span> Download Excel (.xlsx)
        </button>
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="🔍 Cari berdasarkan PERNER, NIP, Nama, atau Bidang..."
          />
        </div>
      </div>

      <!-- Alert Messages -->
      <div id="alertContainer"></div>

      <!-- Statistics -->
      <div id="statsContainer" class="stats">
        <div class="stats-grid" id="statsGrid">
          <!-- Stats akan di-generate oleh JavaScript -->
        </div>
      </div>

      <!-- Loading -->
      <div id="loadingContainer" class="loading">
        <div class="loading-spinner"></div>
        <div>Memproses data...</div>
      </div>

      <!-- Table -->
      <div class="table-container" id="tableContainer">
        <div
          class="scroll-indicator"
          id="scrollIndicator"
          style="display: none"
        >
          ← Scroll untuk melihat kolom lainnya →
        </div>
        <div class="table-scroll-wrapper" id="tableScrollWrapper">
          <div class="no-data" id="noDataMessage">
            📋 Belum ada data rekap. Klik tombol "Generate Rekap Absensi" untuk
            memulai.
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div id="paginationContainer" class="pagination" style="display: none">
        <!-- Pagination akan di-generate oleh JavaScript -->
      </div>
    </div>

    <script>
      const BASE_URL =
        (window.BASE_URL && window.BASE_URL.trim()) || window.location.origin;

      // Helper fetch: aman jika path tanpa "/" di depan.
      const api = (path, opts) => {
        const p = path.startsWith("/") ? path : `/${path}`;
        return fetch(`${BASE_URL}${p}`, opts);
      };

      // Global variables
      let currentPage = 1;
      let itemsPerPage = 50;
      let totalPages = 1;
      let searchQuery = "";
      let currentData = []; // Store current data for export

      // DOM Elements
      const generateBtn = document.getElementById("generateBtn");
      const refreshBtn = document.getElementById("refreshBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const searchInput = document.getElementById("searchInput");
      const alertContainer = document.getElementById("alertContainer");
      const statsContainer = document.getElementById("statsContainer");
      const loadingContainer = document.getElementById("loadingContainer");
      const tableContainer = document.getElementById("tableContainer");
      const tableScrollWrapper = document.getElementById("tableScrollWrapper");
      const scrollIndicator = document.getElementById("scrollIndicator");
      const paginationContainer = document.getElementById(
        "paginationContainer"
      );
      const noDataMessage = document.getElementById("noDataMessage");

      // Event Listeners
      generateBtn.addEventListener("click", generateRekap);
      refreshBtn.addEventListener("click", loadRekapData);
      downloadBtn.addEventListener("click", downloadExcel);
      searchInput.addEventListener("input", debounce(handleSearch, 500));

      // Download Excel Function (.xlsx format with merged headers)
      async function downloadExcel() {
        try {
          if (!currentData || currentData.length === 0) {
            showAlert(
              "❌ Tidak ada data untuk diunduh. Generate rekap terlebih dahulu.",
              "error"
            );
            return;
          }

          showLoading(true);
          showAlert("📊 Mengunduh data dalam format Excel (.xlsx)...", "info");

          // Get all data (not just current page) for export
          const searchParams = new URLSearchParams({
            limit: 10000,
            offset: 0,
            search: searchQuery,
            search_fields: "PERNER,NAMA,NIP,BIDANG_UNIT",
          });

          const allDataResponse = await fetch(
            `${BASE_URL}/get-rekap-absensi?${searchParams.toString()}`
          );
          const allDataResult = await allDataResponse.json();

          if (!allDataResult.success) {
            throw new Error("Gagal mengambil data lengkap");
          }

          const data = allDataResult.data;
          console.log(`📊 Exporting ${data.length} records to Excel (.xlsx)`);

          // Create workbook
          const wb = XLSX.utils.book_new();

          // Create worksheet data manually with merged headers
          const ws = {};

          // Set worksheet range
          const totalRows = data.length + 2; // +2 for header rows
          const totalCols = 34; // Total columns (increased for NIP column)
          ws["!ref"] = XLSX.utils.encode_range({
            s: { c: 0, r: 0 },
            e: { c: totalCols - 1, r: totalRows - 1 },
          });

          // Row 1: Main headers (merged) - sesuai dengan struktur baru
          const mainHeaders = [
            { value: "PERNER", col: 0 },
            { value: "NIP", col: 1 },
            { value: "NAMA", col: 2 },
            { value: "BIDANG/UNIT", col: 3 },
            { value: "JUMLAH HARI REGULER", col: 4, span: 3 },
            { value: "JUMLAH HARI REALISASI", col: 7, span: 3 },
            { value: "DATA KOREKSI", col: 10, span: 5 },
            { value: "POLA JAM KERJA NORMAL", col: 15, span: 4 },
            { value: "POLA JAM KERJA SHIFT", col: 19, span: 5 },
            { value: "KETERANGAN ABSEN MASUK DAN PULANG", col: 24, span: 3 },
            { value: "PENGAJUAN KETIDAKHADIRAN", col: 27, span: 2 },
            { value: "PEROLEHAN DURASI JAM KERJA", col: 29, span: 3 },
          ];

          // Row 2: Sub headers - sesuai dengan struktur baru
          const subHeaders = [
            "PERNER",
            "NIP",
            "NAMA",
            "BIDANG/UNIT",
            // JUMLAH HARI REGULER
            "TOTAL HARI",
            "HARI KERJA",
            "HARI LIBUR",
            // JUMLAH HARI REALISASI
            "TOTAL HARI",
            "HARI KERJA",
            "HARI LIBUR",
            // DATA KOREKSI
            "TOTAL TANPA KOREKSI",
            "TOTAL HARI KOREKSI",
            "KOREKSI IN",
            "KOREKSI OUT",
            "KOREKSI IN & OUT",
            // POLA JAM KERJA NORMAL
            "TOTAL JAM KERJA NORMAL",
            "PIKET",
            "PDKB",
            "REGULER",
            // POLA JAM KERJA SHIFT
            "TOTAL JAM KERJA SHIFT",
            "SHIFT PAGI",
            "SHIFT SIANG",
            "SHIFT MALAM",
            "SHIFT OFF",
            // KETERANGAN ABSEN MASUK DAN PULANG
            "TOTAL ABSEN LENGKAP",
            "TOTAL ABSEN TIDAK LENGKAP",
            "TIDAK ABSEN",
            "IN KOSONG",
            "OUT KOSONG",
            // PENGAJUAN KETIDAKHADIRAN
            "SPPD/TUGAS LUAR DLL",
            "CUTI/IJIN",
            // PEROLEHAN DURASI JAM KERJA
            "JAM REALISASI",
            "JAM SEHARUSNYA",
            "PERSENTASE JKP (%)",
          ];

          // Create main headers (row 0)
          mainHeaders.forEach((header) => {
            const cellRef = XLSX.utils.encode_cell({ r: 0, c: header.col });
            ws[cellRef] = {
              v: header.value,
              t: "s",
              s: {
                font: { bold: true, color: { rgb: "FFFFFF" }, size: 11 },
                fill: { fgColor: { rgb: "2196F3" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "FFFFFF" } },
                  bottom: { style: "thin", color: { rgb: "FFFFFF" } },
                  left: { style: "thin", color: { rgb: "FFFFFF" } },
                  right: { style: "thin", color: { rgb: "FFFFFF" } },
                },
              },
            };
          });

          // Create sub headers (row 1)
          subHeaders.forEach((header, index) => {
            const cellRef = XLSX.utils.encode_cell({ r: 1, c: index });
            ws[cellRef] = {
              v: header,
              t: "s",
              s: {
                font: { bold: true, color: { rgb: "FFFFFF" }, size: 10 },
                fill: { fgColor: { rgb: "11998E" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "FFFFFF" } },
                  bottom: { style: "thin", color: { rgb: "FFFFFF" } },
                  left: { style: "thin", color: { rgb: "FFFFFF" } },
                  right: { style: "thin", color: { rgb: "FFFFFF" } },
                },
              },
            };
          });

          // Add data rows (starting from row 2) - sesuai dengan mapping baru
          data.forEach((row, rowIndex) => {
            const dataRow = [
              row.PERNER,
              row.NIP || "-",
              row.NAMA || "-",
              row.BIDANG_UNIT || "-",
              // JUMLAH HARI REGULER
              parseInt(row.TOTAL_HARI_REGULER || 0),
              parseInt(row.HARI_KERJA_REGULER || 0),
              parseInt(row.HARI_LIBUR_REGULER || 0),
              // JUMLAH HARI REALISASI
              parseInt(row.TOTAL_HARI_REALISASI || 0),
              parseInt(row.HARI_KERJA_REALISASI || 0),
              parseInt(row.HARI_LIBUR_REALISASI || 0),
              // DATA KOREKSI
              parseInt(row.TOTAL_HARI_TANPA_KOREKSI || 0),
              parseInt(row.TOTAL_HARI_KOREKSI || 0),
              parseInt(row.KOREKSI_IN || 0),
              parseInt(row.KOREKSI_OUT || 0),
              parseInt(row.KOREKSI_IN_OUT || 0),
              // POLA JAM KERJA NORMAL
              parseInt(row.TOTAL_JAM_KERJA_NORMAL || 0),
              parseInt(row.PIKET || 0),
              parseInt(row.PDKB || 0),
              parseInt(row.REGULER || 0),
              // POLA JAM KERJA SHIFT
              parseInt(row.TOTAL_JAM_KERJA_SHIFT || 0),
              parseInt(row.SHIFT_PAGI || 0),
              parseInt(row.SHIFT_SIANG || 0),
              parseInt(row.SHIFT_MALAM || 0),
              parseInt(row.SHIFT_OFF || 0),
              // KETERANGAN ABSEN MASUK DAN PULANG
              parseInt(row.ABSEN_LENGKAP || 0),
              0, // TOTAL ABSEN TIDAK LENGKAP (calculated)
              parseInt(row.TIDAK_ABSEN || 0),
              parseInt(row.IN_KOSONG || 0),
              parseInt(row.OUT_KOSONG || 0),
              // PENGAJUAN KETIDAKHADIRAN
              parseInt(row.SPPD_TUGAS_LUAR_DLL || 0),
              parseInt(row.CUTI_IJIN || 0),
              // PEROLEHAN DURASI JAM KERJA
              parseFloat(row.JAM_REALISASI || 0),
              parseFloat(row.JAM_SEHARUSNYA || 0),
              parseFloat(row.PERSENTASE_JKP || 0),
            ];

            dataRow.forEach((cellValue, colIndex) => {
              const cellRef = XLSX.utils.encode_cell({
                r: rowIndex + 2,
                c: colIndex,
              });
              let cellStyle = {
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "CCCCCC" } },
                  bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                  left: { style: "thin", color: { rgb: "CCCCCC" } },
                  right: { style: "thin", color: { rgb: "CCCCCC" } },
                },
              };

              // Special formatting for specific columns
              if (colIndex === 0 || colIndex === 1 || colIndex === 2) {
                // PERNER, NIP, NAMA columns (sticky)
                cellStyle.font = { bold: true };
                cellStyle.fill = { fgColor: { rgb: "E3F2FD" } };
              } else if (colIndex === 3) {
                // BIDANG/UNIT column (non-sticky)
                cellStyle.font = { bold: true };
                cellStyle.fill = { fgColor: { rgb: "F5F5F5" } };
              } else if (colIndex >= 29 && colIndex <= 30) {
                // JAM REALISASI & JAM SEHARUSNYA
                cellStyle.numFmt = "#,##0.00";
              } else if (colIndex === 31) {
                // PERSENTASE JKP
                cellStyle.numFmt = "#,##0.00";

                // Color coding for percentage
                const value = parseFloat(cellValue);
                if (value >= 90) {
                  cellStyle.fill = { fgColor: { rgb: "E8F5E8" } };
                  cellStyle.font = { color: { rgb: "2E7D32" } };
                } else if (value >= 70) {
                  cellStyle.fill = { fgColor: { rgb: "FFF3E0" } };
                  cellStyle.font = { color: { rgb: "F57C00" } };
                } else {
                  cellStyle.fill = { fgColor: { rgb: "FFEBEE" } };
                  cellStyle.font = { color: { rgb: "C62828" } };
                }
              }

              ws[cellRef] = {
                v: cellValue,
                t: typeof cellValue === "number" ? "n" : "s",
                s: cellStyle,
              };
            });
          });

          // Set merge ranges for main headers - sesuai dengan struktur baru
          const merges = [
            { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } }, // PERNER (span 2 rows)
            { s: { r: 0, c: 1 }, e: { r: 1, c: 1 } }, // NIP (span 2 rows)
            { s: { r: 0, c: 2 }, e: { r: 1, c: 2 } }, // NAMA (span 2 rows)
            { s: { r: 0, c: 3 }, e: { r: 1, c: 3 } }, // BIDANG/UNIT (span 2 rows)
            { s: { r: 0, c: 4 }, e: { r: 0, c: 6 } }, // JUMLAH HARI REGULER
            { s: { r: 0, c: 7 }, e: { r: 0, c: 9 } }, // JUMLAH HARI REALISASI
            { s: { r: 0, c: 10 }, e: { r: 0, c: 14 } }, // DATA KOREKSI
            { s: { r: 0, c: 15 }, e: { r: 0, c: 18 } }, // POLA JAM KERJA NORMAL
            { s: { r: 0, c: 19 }, e: { r: 0, c: 23 } }, // POLA JAM KERJA SHIFT
            { s: { r: 0, c: 24 }, e: { r: 0, c: 28 } }, // KETERANGAN ABSEN MASUK DAN PULANG
            { s: { r: 0, c: 29 }, e: { r: 0, c: 30 } }, // PENGAJUAN KETIDAKHADIRAN
            { s: { r: 0, c: 31 }, e: { r: 0, c: 33 } }, // PEROLEHAN DURASI JAM KERJA
          ];
          ws["!merges"] = merges;

          // Set column widths for better readability
          const colWidths = [
            { wch: 12 }, // PERNER
            { wch: 15 }, // NAMA
            { wch: 15 }, // BIDANG/UNIT
            { wch: 10 }, // TOTAL HARI REGULER
            { wch: 10 }, // HARI KERJA REGULER
            { wch: 10 }, // HARI LIBUR REGULER
            { wch: 10 }, // TOTAL HARI REALISASI
            { wch: 10 }, // HARI KERJA REALISASI
            { wch: 10 }, // HARI LIBUR REALISASI
            { wch: 12 }, // TOTAL TANPA KOREKSI
            { wch: 12 }, // TOTAL HARI KOREKSI
            { wch: 10 }, // KOREKSI IN
            { wch: 10 }, // KOREKSI OUT
            { wch: 12 }, // KOREKSI IN & OUT
            { wch: 15 }, // TOTAL JAM KERJA NORMAL
            { wch: 8 }, // PIKET
            { wch: 8 }, // PDKB
            { wch: 10 }, // REGULER
            { wch: 15 }, // TOTAL JAM KERJA SHIFT
            { wch: 10 }, // SHIFT PAGI
            { wch: 10 }, // SHIFT SIANG
            { wch: 10 }, // SHIFT MALAM
            { wch: 10 }, // SHIFT OFF
            { wch: 12 }, // TOTAL ABSEN LENGKAP
            { wch: 15 }, // TOTAL ABSEN TIDAK LENGKAP
            { wch: 10 }, // TIDAK ABSEN
            { wch: 10 }, // IN KOSONG
            { wch: 10 }, // OUT KOSONG
            { wch: 15 }, // SPPD/TUGAS LUAR DLL
            { wch: 10 }, // CUTI/IJIN
            { wch: 12 }, // JAM REALISASI
            { wch: 12 }, // JAM SEHARUSNYA
            { wch: 12 }, // PERSENTASE JKP
          ];
          ws["!cols"] = colWidths;

          // Set row heights for headers
          ws["!rows"] = [
            { hpt: 25 }, // Row 0 height
            { hpt: 20 }, // Row 1 height
          ];

          // Add worksheet to workbook
          XLSX.utils.book_append_sheet(wb, ws, "Rekap Absensi");

          // Generate filename
          const timestamp = new Date().toISOString().split("T")[0];
          const filename = `Rekap_Absensi_${timestamp}${
            searchQuery ? "_Filtered" : ""
          }.xlsx`;

          // Write and download file
          XLSX.writeFile(wb, filename);

          showAlert(
            `✅ File "${filename}" berhasil diunduh! (${data.length} records)`,
            "success"
          );
        } catch (error) {
          console.error("Download error:", error);
          let errorMessage = "❌ Gagal mengunduh file: ";

          if (error.message.includes("XLSX is not defined")) {
            errorMessage +=
              "Library Excel tidak tersedia. Refresh halaman dan coba lagi.";
          } else {
            errorMessage += error.message;
          }

          showAlert(errorMessage, "error");
        } finally {
          showLoading(false);
        }
      }

      // Generate Rekap Function
      async function generateRekap() {
        try {
          showLoading(true);
          showAlert("🔄 Memulai proses generate rekap absensi...", "info");

          generateBtn.disabled = true;
          refreshBtn.disabled = true;

          console.log("🚀 Generate rekap started...");
          console.log("🔗 POST URL:", `${BASE_URL}/generate-rekap-absensi`);

          const response = await fetch(`${BASE_URL}/generate-rekap-absensi`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            mode: "cors",
          });

          console.log("📡 Response status:", response.status);
          console.log("📡 Response headers:", [...response.headers.entries()]);

          if (!response.ok) {
            const errorText = await response.text();
            console.error("❌ Server response error:", errorText);
            throw new Error(
              `HTTP Error: ${response.status} - ${
                response.statusText
              }\nResponse: ${errorText.substring(0, 200)}`
            );
          }

          const contentType = response.headers.get("content-type");
          console.log("📄 Content-Type:", contentType);

          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            console.error("❌ Non-JSON response:", text);
            throw new Error(
              `Server mengembalikan response non-JSON: ${text.substring(
                0,
                200
              )}...`
            );
          }

          const result = await response.json();
          console.log("✅ Generate result:", result);

          if (result.success) {
            showAlert(`✅ ${result.message}`, "success");
            if (result.stats) {
              displayStats(result.stats);
            }
            await loadRekapData();
          } else {
            showAlert(
              `❌ ${result.message || "Generate rekap gagal"}`,
              "error"
            );
          }
        } catch (error) {
          console.error("❌ Generate rekap error:", error);

          // Better error messages
          let errorMessage = "❌ Terjadi kesalahan: ";
          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("NetworkError")
          ) {
            errorMessage += `Server tidak dapat diakses. Pastikan server sudah berjalan di ${BASE_URL}.`;
          } else if (error.message.includes("404")) {
            errorMessage +=
              "Endpoint tidak ditemukan. Periksa apakah server sudah running dengan benar.";
          } else if (error.message.includes("405")) {
            errorMessage +=
              "Method tidak diizinkan. Periksa server routing dan CORS configuration.";
          } else if (error.message.includes("500")) {
            errorMessage +=
              "Kesalahan server internal. Periksa database connection dan console server.";
          } else {
            errorMessage += error.message;
          }

          showAlert(errorMessage, "error");
        } finally {
          showLoading(false);
          generateBtn.disabled = false;
          refreshBtn.disabled = false;
        }
      }

      // Load Rekap Data Function
      async function loadRekapData() {
        try {
          showLoading(true);

          const offset = (currentPage - 1) * itemsPerPage;

          // Enhanced search with multiple fields
          const searchParams = new URLSearchParams({
            limit: itemsPerPage,
            offset: offset,
            search: searchQuery,
            search_fields: "PERNER,NAMA,NIP,BIDANG_UNIT", // Specify which fields to search
          });

          const url = `${BASE_URL}/get-rekap-absensi?${searchParams.toString()}`;

          console.log("🔗 API Request URL:", url);
          console.log("🔍 Search Query:", searchQuery);
          console.log("🎯 Search Fields: PERNER, NAMA, NIP, BIDANG_UNIT");

          const response = await fetch(url);
          const result = await response.json();

          if (result.success) {
            displayRekapData(result.data);
            displayPagination(result.pagination);

            if (result.data.length > 0) {
              noDataMessage.style.display = "none";
              statsContainer.style.display = "block";
              downloadBtn.disabled = false;
            } else {
              noDataMessage.style.display = "block";
              downloadBtn.disabled = true;
              noDataMessage.innerHTML = searchQuery
                ? `🔍 Tidak ada data yang sesuai dengan pencarian "${searchQuery}".`
                : '📋 Belum ada data rekap. Klik tombol "Generate Rekap Absensi" untuk memulai.';
            }
          } else {
            showAlert(`❌ ${result.message}`, "error");
          }
        } catch (error) {
          console.error("Error loading data:", error);
          showAlert("❌ Terjadi kesalahan saat memuat data.", "error");
        } finally {
          showLoading(false);
        }
      }

      // Display Rekap Data in Table
      function displayRekapData(data) {
        if (!data || data.length === 0) {
          tableScrollWrapper.innerHTML = `<div class="no-data">📋 Tidak ada data untuk ditampilkan.</div>`;
          downloadBtn.disabled = true;
          return;
        }

        // Store current data for export
        currentData = data;
        downloadBtn.disabled = false;

        const table = `
          <table>
            <thead>
              <tr class="main-header">
                <th rowspan="2" class="sticky-left-1">PERNER</th>
                <th rowspan="2" class="sticky-left-2">NIP</th>
                <th rowspan="2" class="sticky-left-3">NAMA</th>
                <th rowspan="2">BIDANG/UNIT</th>
                <th colspan="3">JUMLAH HARI REGULER</th>
                <th colspan="3">JUMLAH HARI REALISASI</th>
                <th colspan="5">DATA KOREKSI</th>
                <th colspan="4">POLA JAM KERJA NORMAL</th>
                <th colspan="5">POLA JAM KERJA SHIFT</th>
                <th colspan="5">KETERANGAN ABSEN MASUK DAN PULANG</th>
                <th colspan="2">PENGAJUAN KETIDAKHADIRAN</th>
                <th colspan="3">PEROLEHAN DURASI JAM KERJA</th>
              </tr>
              <tr class="sub-header">
                <th>TOTAL HARI</th>
                <th>HARI KERJA</th>
                <th>HARI LIBUR</th>
                <th>TOTAL HARI</th>
                <th>HARI KERJA</th>
                <th>HARI LIBUR</th>
                <th>TOTAL TANPA KOREKSI</th>
                <th>TOTAL HARI KOREKSI</th>
                <th>KOREKSI IN</th>
                <th>KOREKSI OUT</th>
                <th>KOREKSI IN & OUT</th>
                <th>TOTAL JAM KERJA NORMAL</th>
                <th>PIKET</th>
                <th>PDKB</th>
                <th>REGULER</th>
                <th>TOTAL JAM KERJA SHIFT</th>
                <th>SHIFT PAGI</th>
                <th>SHIFT SIANG</th>
                <th>SHIFT MALAM</th>
                <th>SHIFT OFF</th>
                <th>TOTAL ABSEN LENGKAP</th>
                <th>TOTAL ABSEN TIDAK LENGKAP</th>
                <th>TIDAK ABSEN</th>
                <th>IN KOSONG</th>
                <th>OUT KOSONG</th>
                <th>SPPD/TUGAS LUAR DLL</th>
                <th>CUTI/IJIN</th>
                <th>JAM REALISASI</th>
                <th>JAM SEHARUSNYA</th>
                <th>PERSENTASE JKP (%)</th>
              </tr>
            </thead>
            <tbody>
              ${data
                .map(
                  (row) => `
                  <tr>
                    <td class="sticky-left-1">${row.PERNER}</td>
                    <td class="sticky-left-2">${row.NIP || "-"}</td>
                    <td class="sticky-left-3">${row.NAMA || "-"}</td>
                    <td class="bidang-unit">${row.BIDANG_UNIT || "-"}</td>
                    <td>${row.TOTAL_HARI_REGULER || 0}</td>
                    <td>${row.HARI_KERJA_REGULER || 0}</td>
                    <td>${row.HARI_LIBUR_REGULER || 0}</td>
                    <td>${row.TOTAL_HARI_REALISASI || 0}</td>
                    <td>${row.HARI_KERJA_REALISASI || 0}</td>
                    <td>${row.HARI_LIBUR_REALISASI || 0}</td>
                    <td>${row.TOTAL_HARI_TANPA_KOREKSI || 0}</td>
                    <td>${row.TOTAL_HARI_KOREKSI || 0}</td>
                    <td>${row.KOREKSI_IN || 0}</td>
                    <td>${row.KOREKSI_OUT || 0}</td>
                    <td>${row.KOREKSI_IN_OUT || 0}</td>
                    <td>${row.TOTAL_JAM_KERJA_NORMAL || 0}</td>
                    <td>${row.PIKET || 0}</td>
                    <td>${row.PDKB || 0}</td>
                    <td>${row.REGULER || 0}</td>
                    <td>${row.TOTAL_JAM_KERJA_SHIFT || 0}</td>
                    <td>${row.SHIFT_PAGI || 0}</td>
                    <td>${row.SHIFT_SIANG || 0}</td>
                    <td>${row.SHIFT_MALAM || 0}</td>
                    <td>${row.SHIFT_OFF || 0}</td>
                    <td>${row.ABSEN_LENGKAP || 0}</td>
                    <td>${calculateTotalAbsenTidakLengkap(row)}</td>
                    <td>${row.TIDAK_ABSEN || 0}</td>
                    <td>${row.IN_KOSONG || 0}</td>
                    <td>${row.OUT_KOSONG || 0}</td>
                    <td>${row.SPPD_TUGAS_LUAR_DLL || 0}</td>
                    <td>${row.CUTI_IJIN || 0}</td>
                    <td>${parseFloat(row.JAM_REALISASI || 0).toFixed(2)}</td>
                    <td>${parseFloat(row.JAM_SEHARUSNYA || 0).toFixed(2)}</td>
                    <td class="percentage ${getPercentageClass(
                      row.PERSENTASE_JKP
                    )}">${parseFloat(row.PERSENTASE_JKP || 0).toFixed(2)}</td>
                  </tr>
                `
                )
                .join("")}
            </tbody>
          </table>
        `;

        tableScrollWrapper.innerHTML = table;

        // Hitung tinggi baris header agar offset sticky akurat di semua device
        const mainHeaderRow = tableScrollWrapper.querySelector(
          "thead tr.main-header"
        );
        const subHeaderRow = tableScrollWrapper.querySelector(
          "thead tr.sub-header"
        );

        if (mainHeaderRow && subHeaderRow) {
          const h1 = Math.ceil(mainHeaderRow.getBoundingClientRect().height);
          const h2 = Math.ceil(subHeaderRow.getBoundingClientRect().height);
          tableScrollWrapper.style.setProperty("--header-row-1", `${0}px`);
          tableScrollWrapper.style.setProperty("--header-row-2", `${h1}px`);
        }

        // Show scroll indicator for wide tables
        showScrollIndicator();

        // Add scroll event listener to hide indicator after user scrolls
        tableScrollWrapper.addEventListener("scroll", () => {
          scrollIndicator.style.display = "none";
        });
      }

      // Helper function to calculate Total Absen Tidak Lengkap
      function calculateTotalAbsenTidakLengkap(row) {
        const tidakAbsen = parseInt(row.TIDAK_ABSEN || 0);
        const inKosong = parseInt(row.IN_KOSONG || 0);
        const outKosong = parseInt(row.OUT_KOSONG || 0);
        return tidakAbsen + inKosong + outKosong;
      }

      // Get percentage class for styling
      function getPercentageClass(percentage) {
        const pct = parseFloat(percentage);
        if (pct >= 90) return "high";
        if (pct >= 70) return "medium";
        return "low";
      }

      // Display Statistics
      function displayStats(stats) {
        const statsGrid = document.getElementById("statsGrid");
        statsGrid.innerHTML = `
          <div class="stat-card">
            <h3>Total Pegawai</h3>
            <p>${stats.total_pegawai || 0}</p>
          </div>
          <div class="stat-card">
            <h3>Rata-rata JKP</h3>
            <p>${stats.avg_persentase || 0}%</p>
          </div>
          <div class="stat-card">
            <h3>Total Jam Realisasi</h3>
            <p>${parseFloat(stats.total_jam_realisasi || 0).toFixed(1)}</p>
          </div>
          <div class="stat-card">
            <h3>Total Jam Seharusnya</h3>
            <p>${parseFloat(stats.total_jam_seharusnya || 0).toFixed(1)}</p>
          </div>
        `;
        statsContainer.style.display = "block";
      }

      // Display Pagination
      function displayPagination(pagination) {
        if (!pagination) {
          paginationContainer.style.display = "none";
          return;
        }

        totalPages = pagination.totalPages;
        currentPage = Math.floor(pagination.offset / pagination.limit) + 1;

        // Calculate display information
        const startIndex = pagination.offset + 1;
        const endIndex = Math.min(
          pagination.offset + pagination.limit,
          pagination.total
        );
        const totalRecords = pagination.total;

        let paginationHTML = `
          <!-- Informasi Data -->
          <div class="pagination-info">
            <div class="primary-info">
              Menampilkan ${startIndex} - ${endIndex} dari ${totalRecords} data
            </div>
            <div class="secondary-info">
              Halaman ${currentPage} dari ${totalPages} halaman
              ${
                searchQuery
                  ? ` | Pencarian: "${searchQuery}" (PERNER, NIP, Nama, Bidang)`
                  : ""
              }
            </div>
          </div>

          <div class="pagination-controls">
            <!-- Items per page -->
            <div class="items-per-page-group">
              <span>Tampilkan:</span>
              <select class="items-per-page-select" onchange="changeItemsPerPage(this.value)">
                <option value="25" ${
                  itemsPerPage === 25 ? "selected" : ""
                }>25</option>
                <option value="50" ${
                  itemsPerPage === 50 ? "selected" : ""
                }>50</option>
                <option value="100" ${
                  itemsPerPage === 100 ? "selected" : ""
                }>100</option>
                <option value="200" ${
                  itemsPerPage === 200 ? "selected" : ""
                }>200</option>
              </select>
              <span>per halaman</span>
            </div>

            <!-- Navigation Controls -->
            <div class="pagination-navigation">
              <button onclick="goToPage(1)" ${
                currentPage === 1 ? "disabled" : ""
              } title="Halaman Pertama">
                ««
              </button>
              <button onclick="goToPage(${currentPage - 1})" ${
          currentPage === 1 ? "disabled" : ""
        } title="Halaman Sebelumnya">
                ‹
              </button>
        `;

        // Show page numbers with smart truncation
        if (totalPages <= 7) {
          // Show all pages if 7 or fewer
          for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `
              <button onclick="goToPage(${i})" class="${
              i === currentPage ? "active" : ""
            }" title="Halaman ${i}">
                ${i}
              </button>
            `;
          }
        } else {
          // Smart pagination with ellipsis
          if (currentPage <= 3) {
            // Show: 1 2 3 4 ... last
            for (let i = 1; i <= 4; i++) {
              paginationHTML += `
                <button onclick="goToPage(${i})" class="${
                i === currentPage ? "active" : ""
              }" title="Halaman ${i}">
                  ${i}
                </button>
              `;
            }
            paginationHTML += `<span style="padding: 8px;">...</span>`;
            paginationHTML += `
              <button onclick="goToPage(${totalPages})" title="Halaman ${totalPages}">
                ${totalPages}
              </button>
            `;
          } else if (currentPage >= totalPages - 2) {
            // Show: 1 ... last-3 last-2 last-1 last
            paginationHTML += `
              <button onclick="goToPage(1)" title="Halaman 1">1</button>
            `;
            paginationHTML += `<span style="padding: 8px;">...</span>`;
            for (let i = totalPages - 3; i <= totalPages; i++) {
              paginationHTML += `
                <button onclick="goToPage(${i})" class="${
                i === currentPage ? "active" : ""
              }" title="Halaman ${i}">
                  ${i}
                </button>
              `;
            }
          } else {
            // Show: 1 ... current-1 current current+1 ... last
            paginationHTML += `
              <button onclick="goToPage(1)" title="Halaman 1">1</button>
            `;
            paginationHTML += `<span style="padding: 8px;">...</span>`;
            for (let i = currentPage - 1; i <= currentPage + 1; i++) {
              paginationHTML += `
                <button onclick="goToPage(${i})" class="${
                i === currentPage ? "active" : ""
              }" title="Halaman ${i}">
                  ${i}
                </button>
              `;
            }
            paginationHTML += `<span style="padding: 8px;">...</span>`;
            paginationHTML += `
              <button onclick="goToPage(${totalPages})" title="Halaman ${totalPages}">
                ${totalPages}
              </button>
            `;
          }
        }

        paginationHTML += `
              <button onclick="goToPage(${currentPage + 1})" ${
          currentPage === totalPages ? "disabled" : ""
        } title="Halaman Berikutnya">
                ›
              </button>
              <button onclick="goToPage(${totalPages})" ${
          currentPage === totalPages ? "disabled" : ""
        } title="Halaman Terakhir">
                »»
              </button>
            </div>

            <!-- Jump to page -->
            <div class="page-input-group">
              <span>Ke halaman:</span>
              <input 
                type="number" 
                class="page-input" 
                min="1" 
                max="${totalPages}" 
                value="${currentPage}"
                onkeypress="handlePageInputKeypress(event, ${totalPages})"
                onchange="handlePageInputChange(event, ${totalPages})"
                title="Masukkan nomor halaman (1-${totalPages})"
              >
              <button onclick="goToPageFromInput(${totalPages})" title="Pergi ke halaman">
                Go
              </button>
            </div>
          </div>
        `;

        paginationContainer.innerHTML = paginationHTML;
        paginationContainer.style.display = "flex";
      }

      // Change items per page
      function changeItemsPerPage(newItemsPerPage) {
        itemsPerPage = parseInt(newItemsPerPage);
        currentPage = 1; // Reset to first page
        loadRekapData();
      }

      // Handle page input keypress (Enter key)
      function handlePageInputKeypress(event, maxPages) {
        if (event.key === "Enter") {
          goToPageFromInput(maxPages);
        }
      }

      // Handle page input change
      function handlePageInputChange(event, maxPages) {
        const input = event.target;
        let value = parseInt(input.value);

        if (isNaN(value) || value < 1) {
          input.value = 1;
        } else if (value > maxPages) {
          input.value = maxPages;
        }
      }

      // Go to page from input
      function goToPageFromInput(maxPages) {
        const input = document.querySelector(".page-input");
        let page = parseInt(input.value);

        if (isNaN(page) || page < 1) {
          page = 1;
          input.value = 1;
        } else if (page > maxPages) {
          page = maxPages;
          input.value = maxPages;
        }

        if (page !== currentPage) {
          goToPage(page);
        }
      }

      // Go to specific page
      function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        currentPage = page;
        loadRekapData();
      }

      // Handle search
      function handleSearch() {
        const newSearchQuery = searchInput.value.trim();

        // Log search activity for debugging
        console.log("🔍 Search triggered:", {
          previousQuery: searchQuery,
          newQuery: newSearchQuery,
          searchFields: ["PERNER", "NAMA", "NIP", "BIDANG_UNIT"],
        });

        searchQuery = newSearchQuery;
        currentPage = 1; // Reset to first page when searching

        // Show loading state immediately for better UX
        if (searchQuery) {
          showAlert(
            `🔍 Mencari "${searchQuery}" di PERNER, NIP, Nama, dan Bidang...`,
            "info"
          );
        }

        loadRekapData();
      }

      // Show loading state
      function showLoading(show) {
        loadingContainer.style.display = show ? "block" : "none";
      }

      // Show alert messages
      function showAlert(message, type) {
        const alertClass =
          type === "success"
            ? "alert-success"
            : type === "error"
            ? "alert-error"
            : "alert-info";

        const alertHTML = `<div class="alert ${alertClass}">${message}</div>`;
        alertContainer.innerHTML = alertHTML;

        // Auto hide after 5 seconds
        setTimeout(() => {
          alertContainer.innerHTML = "";
        }, 5000);
      }

      // Debounce function
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Show scroll indicator
      function showScrollIndicator() {
        // Only show if table is wider than container
        const table = tableScrollWrapper.querySelector("table");
        if (table && table.scrollWidth > tableScrollWrapper.clientWidth) {
          scrollIndicator.style.display = "block";
          // Auto hide after 3 seconds
          setTimeout(() => {
            scrollIndicator.style.display = "none";
          }, 3000);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadRekapData();
      });
    </script>
    <script src="script.js?v=20250812"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pilih Shift Ganda</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        color: #2c3e50;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 10px,
          rgba(255, 255, 255, 0.05) 10px,
          rgba(255, 255, 255, 0.05) 20px
        );
        animation: shimmer 20s linear infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }

      .header h2 {
        font-size: 2.5em;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        letter-spacing: 1px;
      }

      .content {
        padding: 30px;
      }

      /* Info Container */
      .info-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 1px solid #dee2e6;
        flex-wrap: wrap;
        gap: 15px;
      }

      .selection-info {
        font-weight: 700;
        color: #28a745;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .selection-info::before {
        content: "üìä";
        font-size: 1.2em;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pagination-controls button {
        padding: 10px 16px;
        font-size: 14px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .pagination-controls button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      .pagination-controls button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }

      #per-page {
        padding: 10px 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #per-page:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      #page-info {
        font-weight: 600;
        color: #495057;
        padding: 8px 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      /* Table Container */
      .table-wrapper {
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        background: white;
        margin: 25px 0;
      }

      .scrollable-table {
        max-height: 70vh;
        overflow: auto;
        position: relative;
      }

      /* Custom Scrollbar */
      .scrollable-table::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      .scrollable-table::-webkit-scrollbar-track {
        background: #f1f3f4;
        border-radius: 6px;
      }

      .scrollable-table::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
        border: 2px solid #f1f3f4;
      }

      .scrollable-table::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        position: relative;
      }

      /* Header Styling */
      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 0;
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 3px solid #5a67d8;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .th-content {
        padding: 16px 12px 8px 12px;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
      }

      .th-title {
        margin-bottom: 8px;
        font-weight: 700;
      }

      .filter-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-top: auto;
      }

      .header-filter,
      .header-filter-select {
        width: 100%;
        padding: 6px 8px;
        font-size: 0.75em;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.9);
        color: #2c3e50;
        transition: all 0.3s ease;
      }

      .header-filter:focus,
      .header-filter-select:focus {
        outline: none;
        background: white;
        border-color: #ffd700;
        box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
      }

      .header-filter::placeholder {
        color: #6c757d;
        font-style: italic;
      }

      /* Body Cells */
      td {
        padding: 16px 12px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
        text-align: center;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }

      tr:hover td {
        background-color: rgba(102, 126, 234, 0.05);
      }

      tr:nth-child(even) td {
        background-color: rgba(248, 249, 250, 0.7);
      }

      /* Radio Button Styling */
      td label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin: 6px 0;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid #e9ecef;
        font-weight: 500;
        font-size: 0.85em;
      }

      td label:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
      }

      td label input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #667eea;
        transition: transform 0.2s ease;
      }

      td label input[type="radio"]:checked + span {
        color: #667eea;
        font-weight: 700;
      }

      td label:has(input[type="radio"]:checked) {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        );
        border-color: #667eea;
        box-shadow: 0 2px 12px rgba(102, 126, 234, 0.3);
      }

      /* Special column styling */
      td:first-child {
        font-weight: 700;
        color: #667eea;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.05) 0%,
          rgba(118, 75, 162, 0.05) 100%
        );
      }

      .hasil-pilihan {
        font-weight: 700;
        color: #28a745;
        font-size: 0.9em;
        background: rgba(40, 167, 69, 0.1) !important;
        padding: 12px !important;
        border-radius: 8px;
      }

      /* Button Container */
      .button-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
        padding: 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        flex-wrap: wrap;
      }

      .main-button {
        padding: 16px 32px;
        font-size: 16px;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        min-width: 200px;
      }

      .main-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .main-button:hover::before {
        left: 100%;
      }

      .save-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
      }

      .save-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
      }

      .reset-button {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
      }

      .reset-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(220, 53, 69, 0.4);
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .container {
          margin: 10px;
          border-radius: 15px;
        }

        .content {
          padding: 20px;
        }

        .scrollable-table {
          max-height: 60vh;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .header h2 {
          font-size: 2em;
        }

        .info-container {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }

        .pagination-controls {
          justify-content: center;
        }

        .button-container {
          flex-direction: column;
          align-items: center;
        }

        .main-button {
          width: 100%;
          max-width: 300px;
        }

        .th-content {
          padding: 12px 8px;
          min-height: 100px;
        }

        .header-filter,
        .header-filter-select {
          font-size: 0.7em;
          padding: 4px 6px;
        }

        td {
          padding: 12px 8px;
          font-size: 0.8em;
        }

        td label {
          padding: 6px 8px;
          font-size: 0.75em;
        }
      }

      /* Loading State */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        font-size: 1.2em;
        color: #667eea;
      }

      .loading::after {
        content: "‚è≥";
        margin-left: 10px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h2>üìå Pilih Shift Ganda</h2>
      </div>

      <div class="content">
        <div class="info-container">
          <div class="selection-info">
            <span id="checked-counter">0</span> baris dipilih dari
            <span id="total-counter">0</span> total baris
          </div>
          <div class="pagination-controls">
            <button id="prev-page" disabled>‚Äπ Sebelumnya</button>
            <span id="page-info">Halaman 1</span>
            <button id="next-page">Berikutnya ‚Ä∫</button>
            <select id="per-page">
              <option value="10">10 per halaman</option>
              <option value="25">25 per halaman</option>
              <option value="50" selected>50 per halaman</option>
              <option value="100">100 per halaman</option>
            </select>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="scrollable-table">
            <table id="tabel-shift">
              <thead>
                <tr>
                  <th>
                    <div class="th-content">
                      <div class="th-title">No</div>
                      <div class="filter-container">
                        <input
                          type="text"
                          class="header-filter"
                          data-column="0"
                          placeholder="Cari No..."
                        />
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <div class="th-title">Perner</div>
                      <div class="filter-container">
                        <input
                          type="text"
                          class="header-filter"
                          data-column="1"
                          placeholder="Cari Perner..."
                        />
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <div class="th-title">Tanggal</div>
                      <div class="filter-container">
                        <input
                          type="text"
                          class="header-filter"
                          data-column="2"
                          placeholder="DD/MM/YYYY"
                        />
                        <select class="header-filter-select" data-column="2">
                          <option value="">Semua Tanggal</option>
                        </select>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <div class="th-title">Shift Daily</div>
                      <div class="filter-container">
                        <input
                          type="text"
                          class="header-filter"
                          data-column="3"
                          placeholder="Cari Shift..."
                        />
                        <select class="header-filter-select" data-column="3">
                          <option value="">Semua Options</option>
                        </select>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <div class="th-title">Shift SAP</div>
                      <div class="filter-container">
                        <input
                          type="text"
                          class="header-filter"
                          data-column="4"
                          placeholder="Cari Shift..."
                        />
                        <select class="header-filter-select" data-column="4">
                          <option value="">Semua Options</option>
                        </select>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="th-content">
                      <div class="th-title">Hasil Pilihan</div>
                      <div class="filter-container">
                        <input
                          type="text"
                          class="header-filter"
                          data-column="5"
                          placeholder="Cari Pilihan..."
                        />
                      </div>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="button-container">
          <button class="main-button save-button" onclick="submitPilihan()">
            üíæ Simpan Pilihan
          </button>
          <button
            class="main-button reset-button"
            onclick="resetSemuaPilihan()"
          >
            üîÑ Reset Semua Pilihan
          </button>
        </div>
      </div>
    </div>

    <script>
      const PROD_API = "https://absensi-db.onrender.com"; // API di Render
      const LOCAL_API = "http://localhost:3000"; // Dev lokal

      const host = location.hostname;
      const isLocalHost = /^(localhost|127\.0\.0\.1)$/.test(host);
      const isPrivateLAN =
        /^(10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.(1[6-9]|2\d|3[0-1])\.\d+\.\d+)$/.test(
          host
        );

      const BASE_URL =
        (window.BASE_URL && window.BASE_URL.trim()) ||
        (isLocalHost || isPrivateLAN ? LOCAL_API : PROD_API);

      const api = (path, opts = {}) => {
        const p = path.startsWith("/") ? path : `/${path}`;
        return fetch(`${BASE_URL}${p}`, opts);
      };
      // === END KONFIG ===

      console.log("üîß BASE_URL:", BASE_URL);
      console.log("üåê Current hostname:", location.hostname);
      console.log("üåê Current page URL:", window.location.href);
      console.log(
        "üéØ Environment:",
        location.hostname.includes("onrender.com")
          ? "PRODUCTION"
          : "DEVELOPMENT"
      );

      // Global object untuk menyimpan pilihan user
      let userSelections = {};

      let currentPage = 1;
      let perPage = 50;
      let filteredData = [];
      let allData = [];

      function formatTanggal(isoString) {
        if (!isoString) return "-";
        try {
          const date = new Date(isoString);
          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        } catch (error) {
          return "-";
        }
      }

      function updateCheckedCounter() {
        // Hitung dari userSelections object
        const checkedCount = Object.keys(userSelections).length;
        document.getElementById("checked-counter").textContent = checkedCount;
        document.getElementById("total-counter").textContent = allData.length;
      }

      async function fetchData() {
        const tbody = document.querySelector("#tabel-shift tbody");
        tbody.innerHTML =
          '<tr><td colspan="6" class="loading">Memuat data...</td></tr>';

        try {
          console.log(
            `üîó Fetching shift data from: ${BASE_URL}/get-ganda-shift`
          );
          const res = await fetch(`${BASE_URL}/get-ganda-shift`);

          if (!res.ok) {
            throw new Error(`HTTP Error: ${res.status} - ${res.statusText}`);
          }

          allData = await res.json();
          filteredData = [...allData];

          // Inisialisasi userSelections dari data yang ada (jika ada pilihan _new)
          userSelections = {}; // Reset userSelections sebelum mengisi ulang
          allData.forEach((row) => {
            const rowKey = `${row.perner}_${row.tanggal}`;
            if (
              row.jenis_jam_kerja_shift_daily_new &&
              row.jenis_jam_kerja_shift_daily_new.trim() !== ""
            ) {
              userSelections[rowKey] = {
                perner: row.perner,
                tanggal: row.tanggal,
                field: "daily",
                nilai: row.jenis_jam_kerja_shift_daily_new,
              };
            } else if (
              row.jenis_jam_kerja_shift_sap_new &&
              row.jenis_jam_kerja_shift_sap_new.trim() !== ""
            ) {
              userSelections[rowKey] = {
                perner: row.perner,
                tanggal: row.tanggal,
                field: "sap",
                nilai: row.jenis_jam_kerja_shift_sap_new,
              };
            }
          });

          updateTable();
          updatePaginationControls();
          updateFilterOptions();
          updateCheckedCounter(); // Pastikan counter diupdate setelah data dimuat

          console.log(`‚úÖ Successfully loaded ${allData.length} shift records`);
        } catch (error) {
          console.error("‚ùå Error fetching shift data:", error);

          let errorMessage = "‚ùå Gagal memuat data";
          if (error.message.includes("Failed to fetch")) {
            errorMessage += `: Server tidak dapat diakses di ${BASE_URL}. Pastikan server sudah berjalan.`;
          } else if (error.message.includes("HTTP Error")) {
            errorMessage += `: ${error.message}`;
          } else {
            errorMessage += `: ${error.message}`;
          }

          tbody.innerHTML = `<tr><td colspan="6" style="color: #dc3545;">${errorMessage}</td></tr>`;
        }
      }

      async function submitPilihan() {
        // Ambil data dari userSelections object
        const hasil = [];

        Object.values(userSelections).forEach((selection) => {
          const iso = selection.tanggal;
          const d = new Date(iso);
          d.setDate(d.getDate() + 1); // ‚úÖ tambahkan 1 hari
          const tanggal = d.toISOString().split("T")[0];

          hasil.push({
            perner: selection.perner,
            tanggal: tanggal,
            pilihan: selection.field, // "daily" atau "sap"
            nilai: selection.nilai,
          });
        });

        if (hasil.length === 0) {
          alert("‚ö†Ô∏è Belum ada pilihan yang dipilih.");
          return;
        }

        try {
          console.log(
            `üîó Submitting ${hasil.length} shift selections to: ${BASE_URL}/update-ganda-shift-pilihan`
          );

          const res = await fetch(`${BASE_URL}/update-ganda-shift-pilihan`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data: hasil }),
          });

          if (!res.ok) {
            throw new Error(`HTTP Error: ${res.status} - ${res.statusText}`);
          }

          const json = await res.json();
          alert(
            `‚úÖ Berhasil menyimpan ${hasil.length} pilihan shift dan mengisi value_shift serta is_shift.`
          );

          console.log("‚úÖ Successfully submitted shift selections:", json);
          fetchData(); // Muat ulang data untuk menampilkan perubahan
        } catch (error) {
          console.error("‚ùå Error submitting shift selections:", error);

          let errorMessage = "‚ùå Gagal menyimpan pilihan";
          if (error.message.includes("Failed to fetch")) {
            errorMessage += `: Server tidak dapat diakses di ${BASE_URL}`;
          } else {
            errorMessage += `: ${error.message}`;
          }

          alert(errorMessage);
        }
      }

      async function resetSemuaPilihan() {
        if (!confirm("‚ö†Ô∏è Yakin ingin menghapus semua pilihan shift *_new?"))
          return;

        try {
          console.log(
            `üîó Resetting shift selections at: ${BASE_URL}/reset-shift-ganda`
          );

          const res = await fetch(`${BASE_URL}/reset-shift-ganda`, {
            method: "POST",
          });

          if (!res.ok) {
            throw new Error(`HTTP Error: ${res.status} - ${res.statusText}`);
          }

          const json = await res.json();
          alert(json.message || "‚úÖ Data berhasil direset.");

          console.log("‚úÖ Successfully reset shift selections:", json);

          // Reset userSelections object
          userSelections = {};
          updateCheckedCounter();
          fetchData(); // Muat ulang data untuk menampilkan perubahan
        } catch (error) {
          console.error("‚ùå Error resetting shift data:", error);

          let errorMessage = "‚ùå Gagal mereset data";
          if (error.message.includes("Failed to fetch")) {
            errorMessage += `: Server tidak dapat diakses di ${BASE_URL}`;
          } else {
            errorMessage += `: ${error.message}`;
          }

          alert(errorMessage);
        }
      }

      function updatePaginationControls() {
        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");
        const totalPages = Math.ceil(filteredData.length / perPage);

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        document.getElementById(
          "page-info"
        ).textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
      }

      function updateTable() {
        const startIdx = (currentPage - 1) * perPage;
        const endIdx = startIdx + perPage;
        const pageData = filteredData.slice(startIdx, endIdx);

        const tbody = document.querySelector("#tabel-shift tbody");
        tbody.innerHTML = "";

        if (pageData.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="color: #6c757d; font-style: italic;">üì≠ Tidak ada data yang sesuai dengan filter</td></tr>';
          return;
        }

        pageData.forEach((row, idx) => {
          const tr = document.createElement("tr");

          // Buat kunci unik untuk setiap baris ganda
          const rowKey = `${row.perner}_${row.tanggal}`;

          // Parse shift values
          const dailyValues = (row.jenis_jam_kerja_shift_daily || "")
            .split("||")
            .map((s) => s.trim())
            .filter(Boolean);
          const sapValues = (row.jenis_jam_kerja_shift_sap || "")
            .split("||")
            .map((s) => s.trim())
            .filter(Boolean);

          let rowHtml = `
            <td>${startIdx + idx + 1}</td>
            <td>${row.perner || "-"}</td>
            <td>${formatTanggal(row.tanggal)}</td>
          `;

          // Shift Daily column
          const dailyCell =
            dailyValues.length > 0
              ? dailyValues
                  .map((nilai) => {
                    // Cek apakah radio button ini harus dicentang berdasarkan userSelections
                    const isChecked =
                      userSelections[rowKey] &&
                      userSelections[rowKey].nilai === nilai &&
                      userSelections[rowKey].field === "daily";

                    return `
                  <label>
                    <input type="radio" 
                           name="pilih_${rowKey}" 
                           value="daily" 
                           data-perner="${row.perner}"
                           data-tanggal="${row.tanggal}"
                           data-nilai="${nilai}"
                           ${isChecked ? "checked" : ""}>
                    <span>${nilai}</span>
                  </label>
                `;
                  })
                  .join("")
              : "<span style='color: #6c757d; font-style: italic;'>-</span>";

          // Shift SAP column
          const sapCell =
            sapValues.length > 0
              ? sapValues
                  .map((nilai) => {
                    // Cek apakah radio button ini harus dicentang berdasarkan userSelections
                    const isChecked =
                      userSelections[rowKey] &&
                      userSelections[rowKey].nilai === nilai &&
                      userSelections[rowKey].field === "sap";

                    return `
                  <label>
                    <input type="radio" 
                           name="pilih_${rowKey}" 
                           value="sap" 
                           data-perner="${row.perner}"
                           data-tanggal="${row.tanggal}"
                           data-nilai="${nilai}"
                           ${isChecked ? "checked" : ""}>
                    <span>${nilai}</span>
                  </label>
                `;
                  })
                  .join("")
              : "<span style='color: #6c757d; font-style: italic;'>-</span>";

          // Tentukan hasil pilihan awal berdasarkan userSelections
          const hasilText = userSelections[rowKey]
            ? userSelections[rowKey].nilai
            : "-";

          rowHtml += `
            <td>${dailyCell}</td>
            <td>${sapCell}</td>
            <td class="hasil-pilihan" data-row-key="${rowKey}">${hasilText}</td>
          `;

          tr.innerHTML = rowHtml;
          tbody.appendChild(tr);

          // Event listener untuk update hasil pilihan real-time dan userSelections
          const radios = tr.querySelectorAll('input[type="radio"]');
          radios.forEach((radio) => {
            radio.addEventListener("change", () => {
              const hasilCell = tr.querySelector(".hasil-pilihan");
              const newValue = radio.dataset.nilai || "-";
              const newField = radio.value; // "daily" atau "sap"
              const perner = radio.dataset.perner;
              const tanggal = radio.dataset.tanggal;

              // Perbarui userSelections
              if (radio.checked) {
                userSelections[rowKey] = {
                  perner: perner,
                  tanggal: tanggal,
                  field: newField,
                  nilai: newValue,
                };
              }

              hasilCell.textContent = newValue;
              updateCheckedCounter(); // Panggil untuk memperbarui counter
            });
          });
        });

        document.getElementById("total-counter").textContent =
          filteredData.length;
        updateCheckedCounter(); // Panggil di sini juga untuk memastikan counter akurat saat tabel pertama kali dimuat/diperbarui
      }

      function updateFilterOptions() {
        const selects = document.querySelectorAll(".header-filter-select");

        selects.forEach((select) => {
          const col = parseInt(select.dataset.column);
          let options = [];

          if (col === 2) {
            // Tanggal options
            options = [
              ...new Set(allData.map((row) => formatTanggal(row.tanggal))),
            ];
          } else if (col === 3) {
            // Shift Daily options
            options = [
              ...new Set(
                allData.flatMap((row) =>
                  (row.jenis_jam_kerja_shift_daily || "")
                    .split("||")
                    .map((s) => s.trim())
                    .filter(Boolean)
                )
              ),
            ];
          } else if (col === 4) {
            // Shift SAP options
            options = [
              ...new Set(
                allData.flatMap((row) =>
                  (row.jenis_jam_kerja_shift_sap || "")
                    .split("||")
                    .map((s) => s.trim())
                    .filter(Boolean)
                )
              ),
            ];
          } else if (col === 5) {
            // Hasil Pilihan options
            options = [
              ...new Set(
                allData
                  .map(
                    (row) =>
                      row.jenis_jam_kerja_shift_daily_new ||
                      row.jenis_jam_kerja_shift_sap_new ||
                      ""
                  )
                  .filter(Boolean)
              ),
            ];
          }

          options = options.filter(Boolean).sort();

          select.innerHTML =
            '<option value="">Semua</option>' +
            options
              .map((opt) => `<option value="${opt}">${opt}</option>`)
              .join("");
        });
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function applyFilters() {
        const filters = {};

        // Collect text filters
        document.querySelectorAll(".header-filter").forEach((input) => {
          if (input.value.trim()) {
            filters[input.dataset.column] = {
              type: "text",
              value: input.value.toLowerCase().trim(),
            };
          }
        });

        // Collect select filters
        document.querySelectorAll(".header-filter-select").forEach((select) => {
          if (select.value) {
            filters[select.dataset.column] = {
              type: "exact",
              value: select.value,
            };
          }
        });

        filteredData = allData.filter((row) => {
          return Object.keys(filters).every((col) => {
            const filter = filters[col];
            let cellValue = "";

            switch (parseInt(col)) {
              case 0: // No - skip filtering for row numbers
                return true;
              case 1: // Perner
                cellValue = row.perner || "";
                break;
              case 2: // Tanggal
                cellValue = formatTanggal(row.tanggal);
                break;
              case 3: // Shift Daily
                cellValue = row.jenis_jam_kerja_shift_daily || "";
                break;
              case 4: // Shift SAP
                cellValue = row.jenis_jam_kerja_shift_sap || "";
                break;
              case 5: // Hasil Pilihan
                cellValue =
                  row.jenis_jam_kerja_shift_daily_new ||
                  row.jenis_jam_kerja_shift_sap_new ||
                  "";
                break;
            }

            cellValue = String(cellValue);

            if (filter.type === "text") {
              return cellValue.toLowerCase().includes(filter.value);
            } else if (filter.type === "exact") {
              return cellValue === filter.value;
            }
            return true;
          });
        });

        currentPage = 1;
        updateTable();
        updatePaginationControls();
      }

      // Event listeners for pagination
      document.getElementById("prev-page").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          updateTable();
          updatePaginationControls();
        }
      });

      document.getElementById("next-page").addEventListener("click", () => {
        const totalPages = Math.ceil(filteredData.length / perPage);
        if (currentPage < totalPages) {
          currentPage++;
          updateTable();
          updatePaginationControls();
        }
      });

      document.getElementById("per-page").addEventListener("change", (e) => {
        perPage = parseInt(e.target.value);
        currentPage = 1;
        updateTable();
        updatePaginationControls();
      });

      // Filter implementation
      document.addEventListener("DOMContentLoaded", () => {
        // Text filter inputs
        document.querySelectorAll(".header-filter").forEach((input) => {
          input.addEventListener("input", debounce(applyFilters, 300));
        });

        // Select filter dropdowns
        document.querySelectorAll(".header-filter-select").forEach((select) => {
          select.addEventListener("change", applyFilters);
        });

        // Initialize the page
        console.log(
          `üöÄ Pilih Shift Ganda Manager initialized with BASE_URL: ${BASE_URL}`
        );
        fetchData();
      });
    </script>

    <script src="script.js?v=20250812"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Data Pegawai - File Upload</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .upload-container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .header p {
        color: #7f8c8d;
        font-size: 1.1rem;
      }

      .upload-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        overflow: hidden;
      }

      .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .section-content {
        padding: 30px;
      }

      .instructions {
        background: #e6f3ff;
        border-left: 4px solid #667eea;
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 6px;
      }

      .instructions h3 {
        color: #2d3748;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .instructions ul {
        list-style: none;
        padding-left: 0;
      }

      .instructions li {
        margin-bottom: 8px;
        padding-left: 20px;
        position: relative;
        font-size: 14px;
        color: #4a5568;
      }

      .instructions li::before {
        content: "‚Ä¢";
        color: #667eea;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      .format-example {
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        padding: 15px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        margin: 15px 0;
        overflow-x: auto;
      }

      .upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 25px;
        background: #fafafa;
        position: relative;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: #f0f8ff;
      }

      .upload-area.dragover {
        border-color: #667eea;
        background: #e6f3ff;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 48px;
        color: #cbd5e0;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 18px;
        color: #4a5568;
        margin-bottom: 10px;
        font-weight: 500;
      }

      .upload-hint {
        font-size: 14px;
        color: #718096;
      }

      .file-input {
        display: none;
      }

      .file-info {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        display: none;
      }

      .file-info.show {
        display: block;
      }

      .file-details {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .file-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
      }

      .file-meta {
        flex: 1;
      }

      .file-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 4px;
      }

      .file-size {
        font-size: 12px;
        color: #718096;
      }

      .upload-progress {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
        display: none;
      }

      .upload-progress.show {
        display: block;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.3s ease;
      }

      .progress-text {
        font-size: 12px;
        color: #4a5568;
        text-align: center;
      }

      .validation-info {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        font-size: 14px;
        display: none;
      }

      .validation-info.show {
        display: block;
      }

      .validation-info.success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }

      .validation-info.error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .validation-info.warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        color: white;
      }

      .processing {
        display: none;
        text-align: center;
        padding: 20px;
        color: #667eea;
      }

      .processing.show {
        display: block;
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 50%;
        border-top-color: #667eea;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .results-section {
        display: none;
        margin-top: 20px;
      }

      .results-section.show {
        display: block;
      }

      .results-summary {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .summary-item {
        text-align: center;
      }

      .summary-value {
        font-size: 24px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 5px;
      }

      .summary-label {
        font-size: 12px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .error-list {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
      }

      .error-item {
        padding: 10px 15px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 13px;
      }

      .error-item:last-child {
        border-bottom: none;
      }

      .error-row {
        color: #e53e3e;
        font-weight: 600;
      }

      .error-message {
        color: #4a5568;
        margin-top: 4px;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .section-content {
          padding: 20px;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          min-width: auto;
        }

        .header h1 {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="upload-container">
      <div class="header">
        <h1>üìä Upload Data Pegawai</h1>
        <p>Import data pegawai dari file Excel atau CSV</p>
      </div>

      <!-- Upload Section -->
      <div class="upload-section">
        <div class="section-header">üìÅ Upload File</div>
        <div class="section-content">
          <div class="instructions">
            <h3>Format File yang Didukung:</h3>
            <ul>
              <li>Excel (.xlsx, .xls)</li>
              <li>CSV (.csv) dengan encoding UTF-8</li>
              <li>Maksimal ukuran file: 10MB</li>
              <li>Maksimal 5000 records per upload</li>
            </ul>

            <h3>Format Kolom yang Diperlukan:</h3>
            <div class="format-example">
              Kolom harus mengandung (urutan bebas): - perner (wajib) - nip
              (wajib) - nama (wajib) - bidang (wajib) - no_telp (wajib) Contoh:
              perner | nip | nama | bidang | no_telp P001 | 123456 | John Doe |
              IT | 081234567890 P002 | 123457 | Jane Smith | HR | 081234567891
            </div>
          </div>

          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">
              Klik untuk memilih file atau drag & drop
            </div>
            <div class="upload-hint">Excel (.xlsx, .xls) atau CSV (.csv)</div>
            <input
              type="file"
              id="fileInput"
              class="file-input"
              accept=".xlsx,.xls,.csv"
            />
          </div>

          <div class="file-info" id="fileInfo">
            <div class="file-details">
              <div class="file-icon">üìÑ</div>
              <div class="file-meta">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
              </div>
            </div>
            <div class="upload-progress" id="uploadProgress">
              <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText"></div>
          </div>

          <div class="validation-info" id="validationInfo">
            <div id="validationText"></div>
          </div>

          <div class="processing" id="processing">
            <div class="spinner"></div>
            <span id="processingText">Memproses file...</span>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" id="selectFileBtn">
              üìÅ Pilih File
            </button>
            <button class="btn btn-secondary" id="uploadBtn" disabled>
              ‚¨ÜÔ∏è Upload & Process
            </button>
            <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Clear</button>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="upload-section results-section" id="resultsSection">
        <div class="section-header">üìä Hasil Upload</div>
        <div class="section-content">
          <div class="results-summary" id="resultsSummary">
            <div class="summary-grid" id="summaryGrid">
              <!-- Summary akan diisi oleh JavaScript -->
            </div>
          </div>

          <div class="error-list" id="errorList" style="display: none">
            <!-- Error list akan diisi oleh JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      // Base URL configuration (sama seperti file lain)
      const PROD_API = "https://absensi-db.onrender.com";
      const LOCAL_API = "http://localhost:3000";

      const host = location.hostname;
      const isLocalHost = /^(localhost|127\.0\.0\.1)$/.test(host);
      const isPrivateLAN =
        /^(10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.(1[6-9]|2\d|3[0-1])\.\d+\.\d+)$/.test(
          host
        );

      const BASE_URL =
        (window.BASE_URL && window.BASE_URL.trim()) ||
        (isLocalHost || isPrivateLAN ? LOCAL_API : PROD_API);

      console.log("Using BASE_URL:", BASE_URL);

      // DOM Elements
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");
      const fileName = document.getElementById("fileName");
      const fileSize = document.getElementById("fileSize");
      const uploadProgress = document.getElementById("uploadProgress");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const validationInfo = document.getElementById("validationInfo");
      const validationText = document.getElementById("validationText");
      const processing = document.getElementById("processing");
      const processingText = document.getElementById("processingText");
      const selectFileBtn = document.getElementById("selectFileBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const clearBtn = document.getElementById("clearBtn");
      const resultsSection = document.getElementById("resultsSection");
      const summaryGrid = document.getElementById("summaryGrid");
      const errorList = document.getElementById("errorList");

      // Global variables
      let selectedFile = null;
      let parsedData = [];
      let validationErrors = [];

      // Event listeners
      selectFileBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", handleFileSelect);
      uploadBtn.addEventListener("click", processUpload);
      clearBtn.addEventListener("click", clearAll);

      // Drag & Drop handlers
      uploadArea.addEventListener("dragover", handleDragOver);
      uploadArea.addEventListener("dragleave", handleDragLeave);
      uploadArea.addEventListener("drop", handleDrop);
      uploadArea.addEventListener("click", () => fileInput.click());

      function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      function handleFile(file) {
        // Validate file type
        const allowedTypes = [
          "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", // .xlsx
          "application/vnd.ms-excel", // .xls
          "text/csv", // .csv
        ];

        const fileExtension = file.name.toLowerCase().split(".").pop();
        const allowedExtensions = ["xlsx", "xls", "csv"];

        if (
          !allowedTypes.includes(file.type) &&
          !allowedExtensions.includes(fileExtension)
        ) {
          showValidation(
            "error",
            "Format file tidak didukung. Gunakan Excel (.xlsx, .xls) atau CSV (.csv)"
          );
          return;
        }

        // Validate file size (10MB max)
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
          showValidation("error", "Ukuran file terlalu besar. Maksimal 10MB.");
          return;
        }

        selectedFile = file;
        showFileInfo(file);
        parseFile(file);
      }

      function showFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.classList.add("show");
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function parseFile(file) {
        processing.classList.add("show");
        processingText.textContent = "Membaca file...";

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            let data;
            const fileExtension = file.name.toLowerCase().split(".").pop();

            if (fileExtension === "csv") {
              data = parseCSV(e.target.result);
            } else {
              data = parseExcel(e.target.result);
            }

            if (data && data.length > 0) {
              processingText.textContent = "Memvalidasi data...";
              setTimeout(() => validateData(data), 100);
            } else {
              processing.classList.remove("show");
              showValidation("error", "File kosong atau tidak dapat dibaca.");
            }
          } catch (error) {
            processing.classList.remove("show");
            showValidation("error", `Error membaca file: ${error.message}`);
          }
        };

        if (file.name.toLowerCase().endsWith(".csv")) {
          reader.readAsText(file);
        } else {
          reader.readAsArrayBuffer(file);
        }
      }

      function parseCSV(content) {
        const lines = content.split("\n").filter((line) => line.trim());
        if (lines.length < 2) return [];

        const headers = lines[0].split(",").map((h) => h.trim().toLowerCase());
        const data = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(",").map((v) => v.trim());
          if (values.length >= headers.length) {
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index] || "";
            });
            data.push(row);
          }
        }

        return data;
      }

      function parseExcel(arrayBuffer) {
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        if (data.length < 2) return [];

        const headers = data[0].map((h) =>
          String(h || "")
            .trim()
            .toLowerCase()
        );
        const parsedData = [];

        for (let i = 1; i < data.length; i++) {
          if (data[i].some((cell) => cell !== undefined && cell !== "")) {
            const row = {};
            headers.forEach((header, index) => {
              row[header] = String(data[i][index] || "").trim();
            });
            parsedData.push(row);
          }
        }

        return parsedData;
      }

      function validateData(data) {
        validationErrors = [];
        const requiredFields = ["perner", "nip", "nama", "bidang", "no_telp"];

        // Check max records
        if (data.length > 5000) {
          validationErrors.push(
            `Terlalu banyak data: ${data.length} records. Maksimal 5000 records.`
          );
          processing.classList.remove("show");
          showValidation("error", validationErrors.join("<br>"));
          return;
        }

        // Check headers
        const headers = Object.keys(data[0] || {});
        const missingHeaders = requiredFields.filter(
          (field) =>
            !headers.some((header) => header.toLowerCase().includes(field))
        );

        if (missingHeaders.length > 0) {
          validationErrors.push(
            `Kolom yang hilang: ${missingHeaders.join(", ")}`
          );
        }

        // Validate each row
        const pernerSet = new Set();
        const nipSet = new Set();

        data.forEach((row, index) => {
          const rowNum = index + 1;

          // Check required fields
          requiredFields.forEach((field) => {
            const value = row[field] || "";
            if (!value.trim()) {
              validationErrors.push(`Baris ${rowNum}: ${field} kosong`);
            }
          });

          // Check duplicates
          if (row.perner) {
            if (pernerSet.has(row.perner)) {
              validationErrors.push(
                `Baris ${rowNum}: PERNER ${row.perner} duplikat`
              );
            }
            pernerSet.add(row.perner);
          }

          if (row.nip) {
            if (nipSet.has(row.nip)) {
              validationErrors.push(`Baris ${rowNum}: NIP ${row.nip} duplikat`);
            }
            nipSet.add(row.nip);
          }

          // Check field lengths
          if (row.perner && row.perner.length > 50) {
            validationErrors.push(
              `Baris ${rowNum}: PERNER terlalu panjang (max 50)`
            );
          }
          if (row.nip && row.nip.length > 50) {
            validationErrors.push(
              `Baris ${rowNum}: NIP terlalu panjang (max 50)`
            );
          }
          if (row.nama && row.nama.length > 100) {
            validationErrors.push(
              `Baris ${rowNum}: Nama terlalu panjang (max 100)`
            );
          }
          if (row.bidang && row.bidang.length > 100) {
            validationErrors.push(
              `Baris ${rowNum}: Bidang terlalu panjang (max 100)`
            );
          }
          if (row.no_telp && row.no_telp.length > 20) {
            validationErrors.push(
              `Baris ${rowNum}: No. Telp terlalu panjang (max 20)`
            );
          }
        });

        processing.classList.remove("show");

        if (validationErrors.length > 0) {
          const errorCount = validationErrors.length;
          const maxShow = 10;
          let errorMessage = `Ditemukan ${errorCount} error:<br>`;
          errorMessage += validationErrors.slice(0, maxShow).join("<br>");
          if (errorCount > maxShow) {
            errorMessage += `<br>... dan ${errorCount - maxShow} error lainnya`;
          }
          showValidation("error", errorMessage);
          uploadBtn.disabled = true;
        } else {
          parsedData = data;
          showValidation(
            "success",
            `‚úÖ Data valid! ${data.length} records siap untuk diupload.`
          );
          uploadBtn.disabled = false;
        }
      }

      async function processUpload() {
        if (
          !selectedFile ||
          validationErrors.length > 0 ||
          parsedData.length === 0
        ) {
          showValidation("error", "Tidak ada data valid untuk diupload.");
          return;
        }

        processing.classList.add("show");
        processingText.textContent = "Mengupload ke database...";
        uploadProgress.classList.add("show");

        try {
          // Simulate upload progress
          for (let i = 0; i <= 100; i += 10) {
            progressBar.style.width = i + "%";
            progressText.textContent = `Uploading... ${i}%`;
            await new Promise((resolve) => setTimeout(resolve, 100));
          }

          const response = await fetch(
            `${BASE_URL}/api/data_pegawai/bulk_upload`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                data: parsedData,
                filename: selectedFile.name,
                total_records: parsedData.length,
              }),
            }
          );

          const result = await response.json();

          processing.classList.remove("show");
          uploadProgress.classList.remove("show");

          if (result.success) {
            showResults(result);
            showValidation(
              "success",
              `‚úÖ Upload berhasil! ${result.data.successful_inserts} records berhasil disimpan.`
            );
          } else {
            showValidation("error", `‚ùå Upload gagal: ${result.message}`);
          }
        } catch (error) {
          processing.classList.remove("show");
          uploadProgress.classList.remove("show");
          showValidation("error", `‚ùå Error saat upload: ${error.message}`);
        }
      }

      function showResults(result) {
        const data = result.data;

        summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${data.total_records || 0}</div>
                    <div class="summary-label">Total Records</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" style="color: #38a169;">${
                      data.successful_inserts || 0
                    }</div>
                    <div class="summary-label">Berhasil</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" style="color: #e53e3e;">${
                      data.failed_inserts || 0
                    }</div>
                    <div class="summary-label">Gagal</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" style="color: #667eea;">${
                      data.updated_records || 0
                    }</div>
                    <div class="summary-label">Diupdate</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${Math.round(
                      (data.successful_inserts / data.total_records) * 100
                    )}%</div>
                    <div class="summary-label">Success Rate</div>
                </div>
            `;

        if (data.errors && data.errors.length > 0) {
          errorList.style.display = "block";
          errorList.innerHTML = data.errors
            .map(
              (error) => `
                    <div class="error-item">
                        <div class="error-row">Row ${
                          error.row || "Unknown"
                        }</div>
                        <div class="error-message">${
                          error.message || error
                        }</div>
                    </div>
                `
            )
            .join("");
        }

        resultsSection.classList.add("show");
      }

      function showValidation(type, message) {
        validationInfo.className = `validation-info show ${type}`;
        validationText.innerHTML = message;
      }

      function clearAll() {
        selectedFile = null;
        parsedData = [];
        validationErrors = [];

        fileInfo.classList.remove("show");
        uploadProgress.classList.remove("show");
        validationInfo.classList.remove("show");
        processing.classList.remove("show");
        resultsSection.classList.remove("show");

        fileInput.value = "";
        uploadBtn.disabled = true;
        progressBar.style.width = "0%";
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Upload Data Pegawai page initialized");
        console.log("Using BASE_URL:", BASE_URL);
      });
    </script>
  </body>
</html>

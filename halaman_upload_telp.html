<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Data Pegawai - Paste Data</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .upload-container {
        max-width: 1000px;
        margin: 0 auto;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .header p {
        color: #7f8c8d;
        font-size: 1.1rem;
      }

      .upload-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        overflow: hidden;
      }

      .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .section-content {
        padding: 30px;
      }

      .instructions {
        background: #e6f3ff;
        border-left: 4px solid #667eea;
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 6px;
      }

      .instructions h3 {
        color: #2d3748;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .instructions ul {
        list-style: none;
        padding-left: 0;
      }

      .instructions li {
        margin-bottom: 8px;
        padding-left: 20px;
        position: relative;
        font-size: 14px;
        color: #4a5568;
      }

      .instructions li::before {
        content: "•";
        color: #667eea;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      .format-example {
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        padding: 15px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        margin: 15px 0;
        overflow-x: auto;
      }

      .paste-area {
        border: 2px solid #cbd5e0;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 25px;
        background: #fafafa;
        transition: all 0.3s ease;
        position: relative;
      }

      .paste-area:focus-within {
        border-color: #667eea;
        background: #f0f8ff;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .paste-label {
        display: block;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .paste-textarea {
        width: 100%;
        min-height: 300px;
        border: none;
        background: transparent;
        font-family: "Courier New", monospace;
        font-size: 13px;
        color: #2d3748;
        resize: vertical;
        outline: none;
        line-height: 1.5;
      }

      .paste-textarea::placeholder {
        color: #a0aec0;
        font-style: italic;
      }

      .format-options {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        align-items: center;
      }

      .format-option {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .format-option input[type="radio"] {
        margin: 0;
      }

      .format-option label {
        font-size: 14px;
        color: #4a5568;
        cursor: pointer;
      }

      .data-info {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        display: none;
      }

      .data-info.show {
        display: block;
      }

      .data-summary {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .summary-item {
        background: #f7fafc;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: #4a5568;
      }

      .summary-value {
        font-weight: 600;
        color: #2d3748;
      }

      .validation-info {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        font-size: 14px;
        display: none;
      }

      .validation-info.show {
        display: block;
      }

      .validation-info.success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }

      .validation-info.error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .validation-info.warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        color: white;
      }

      .btn-info {
        background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        color: white;
      }

      .processing {
        display: none;
        text-align: center;
        padding: 20px;
        color: #667eea;
      }

      .processing.show {
        display: block;
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 50%;
        border-top-color: #667eea;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .results-section {
        display: none;
        margin-top: 20px;
      }

      .results-section.show {
        display: block;
      }

      .results-summary {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .summary-item-large {
        text-align: center;
      }

      .summary-value-large {
        font-size: 24px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 5px;
      }

      .summary-label {
        font-size: 12px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .error-list {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
      }

      .error-item {
        padding: 10px 15px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 13px;
      }

      .error-item:last-child {
        border-bottom: none;
      }

      .error-row {
        color: #e53e3e;
        font-weight: 600;
      }

      .error-message {
        color: #4a5568;
        margin-top: 4px;
      }

      .sample-toggle {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 10px 15px;
        margin-bottom: 15px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
      }

      .sample-toggle:hover {
        background: #edf2f7;
      }

      .sample-toggle.active {
        background: #e6f3ff;
        border-color: #667eea;
      }

      .sample-content {
        display: none;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e2e8f0;
      }

      .sample-content.show {
        display: block;
      }

      .copy-sample {
        font-size: 12px;
        color: #667eea;
        text-decoration: underline;
        cursor: pointer;
        margin-left: 10px;
      }

      .duplicate-handling {
        margin: 20px 0;
        transition: all 0.3s ease;
      }

      .duplicate-options {
        display: grid;
        gap: 15px;
        margin-top: 15px;
      }

      .duplicate-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 15px;
        background: #f8f9fa;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .duplicate-option:hover {
        background: #f1f5f9;
        border-color: #cbd5e0;
      }

      .duplicate-option input[type="radio"] {
        margin: 0;
        margin-top: 2px;
      }

      .duplicate-option input[type="radio"]:checked ~ label {
        color: #2d3748;
      }

      .duplicate-option:has(input:checked) {
        background: #e6f3ff;
        border-color: #667eea;
      }

      .duplicate-option label {
        cursor: pointer;
        flex: 1;
        margin: 0;
      }

      .duplicate-option label strong {
        display: block;
        color: #2d3748;
        margin-bottom: 4px;
        font-size: 14px;
      }

      .option-description {
        color: #4a5568;
        font-size: 12px;
        line-height: 1.4;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .section-content {
          padding: 20px;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          min-width: auto;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        .format-options {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="upload-container">
      <div class="header">
        <h1>📊 Upload Data Pegawai</h1>
        <p>Import data pegawai dengan copy-paste dari Excel atau CSV</p>
      </div>

      <!-- Upload Section -->
      <div class="upload-section">
        <div class="section-header">📝 Paste Data</div>
        <div class="section-content">
          <div class="instructions">
            <h3>Cara Menggunakan:</h3>
            <ul>
              <li>Copy data dari Excel atau CSV (termasuk header)</li>
              <li>Paste ke kotak teks di bawah</li>
              <li>Pilih format data (Tab-separated atau Comma-separated)</li>
              <li>Maksimal 5000 records per upload</li>
            </ul>

            <h3>Format Kolom yang Diperlukan:</h3>
            <div class="format-example">
              Kolom harus mengandung (urutan bebas): - perner (wajib) - nip
              (wajib) - nama (wajib) - bidang (wajib) - no_telp (opsional,
              sistem akan membersihkan format otomatis) Sistem akan otomatis
              membersihkan nomor telepon: ✓ +6281355265063 → 081355265063 ✓
              6281355265063 → 081355265063 ✓ 81355265063 → 081355265063 ✓
              +62-812-3456-7890 → 081234567890 ✓ (0812) 345 6789 → 081234567890
              ✓ 0812-345-6789 → 081234567890 ✗ Format tidak valid → - (tanda
              strip) ✗ Kosong → - (tanda strip)
            </div>

            <div class="sample-toggle" onclick="toggleSample()">
              <strong>🔽 Contoh Data (Klik untuk melihat)</strong>
              <span class="copy-sample" onclick="copySampleData(event)"
                >📋 Copy contoh</span
              >
              <div class="sample-content" id="sampleContent">
                <div class="format-example">
                  perner nip nama bidang no_telp P001 123456 John Doe IT
                  +6281355265063 P002 123457 Jane Smith HR 6281355265064 P003
                  123458 Bob Johnson Finance 81355265065 P004 123459 Alice Brown
                  Marketing 0812-345-6789
                </div>
              </div>
            </div>
          </div>

          <div class="format-options">
            <label><strong>Format Data:</strong></label>
            <div class="format-option">
              <input
                type="radio"
                id="formatTab"
                name="dataFormat"
                value="tab"
                checked
              />
              <label for="formatTab">Tab-separated (dari Excel)</label>
            </div>
            <div class="format-option">
              <input
                type="radio"
                id="formatComma"
                name="dataFormat"
                value="comma"
              />
              <label for="formatComma">Comma-separated (CSV)</label>
            </div>
          </div>

          <div class="paste-area">
            <label class="paste-label" for="dataTextarea"
              >Paste data di sini:</label
            >
            <textarea
              id="dataTextarea"
              class="paste-textarea"
              placeholder="Paste data dari Excel atau CSV di sini...

Contoh format (Tab-separated dari Excel):
perner	nip	nama	bidang	no_telp
P001	123456	John Doe	IT	081234567890
P002	123457	Jane Smith	HR	081234567891

Atau format CSV (Comma-separated):
perner,nip,nama,bidang,no_telp
P001,123456,John Doe,IT,081234567890
P002,123457,Jane Smith,HR,081234567891"
              oninput="handleDataInput()"
              onpaste="handleDataPaste()"
            ></textarea>
          </div>

          <div class="data-info" id="dataInfo">
            <div class="data-summary" id="dataSummary">
              <!-- Summary akan diisi oleh JavaScript -->
            </div>
          </div>

          <div class="validation-info" id="validationInfo">
            <div id="validationText"></div>
          </div>

          <div class="processing" id="processing">
            <div class="spinner"></div>
            <span id="processingText">Memproses data...</span>
          </div>

          <div
            class="duplicate-handling"
            id="duplicateHandling"
            style="display: none"
          >
            <div
              class="instructions"
              style="background: #fff3cd; border-left-color: #f39c12"
            >
              <h3>Penanganan Data Duplikat:</h3>
              <div class="duplicate-options">
                <div class="duplicate-option">
                  <input
                    type="radio"
                    id="overwrite"
                    name="duplicateAction"
                    value="overwrite"
                    checked
                  />
                  <label for="overwrite">
                    <strong>Timpa data yang sudah ada</strong>
                    <div class="option-description">
                      Update semua field untuk PERNER yang sudah ada di database
                    </div>
                  </label>
                </div>
                <div class="duplicate-option">
                  <input
                    type="radio"
                    id="skip"
                    name="duplicateAction"
                    value="skip"
                  />
                  <label for="skip">
                    <strong>Abaikan data duplikat</strong>
                    <div class="option-description">
                      Lewati PERNER yang sudah ada, hanya insert data baru
                    </div>
                  </label>
                </div>
                <div class="duplicate-option">
                  <input
                    type="radio"
                    id="merge"
                    name="duplicateAction"
                    value="merge"
                  />
                  <label for="merge">
                    <strong>Gabung data (merge)</strong>
                    <div class="option-description">
                      Update hanya field yang tidak kosong dari data baru
                    </div>
                  </label>
                </div>
                <div class="duplicate-option">
                  <input
                    type="radio"
                    id="backup"
                    name="duplicateAction"
                    value="backup"
                  />
                  <label for="backup">
                    <strong>Timpa dengan backup</strong>
                    <div class="option-description">
                      Backup data lama ke tabel history sebelum update
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="button-group">
            <button
              class="btn btn-info"
              id="parseBtn"
              disabled
              onclick="parseData()"
            >
              🔍 Parse & Validate
            </button>
            <button
              class="btn btn-secondary"
              id="uploadBtn"
              disabled
              onclick="processUpload()"
            >
              ⬆️ Upload ke Database
            </button>
            <button class="btn btn-danger" id="clearBtn" onclick="clearAll()">
              🗑️ Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="upload-section results-section" id="resultsSection">
        <div class="section-header">📊 Hasil Upload</div>
        <div class="section-content">
          <div class="results-summary" id="resultsSummary">
            <div class="summary-grid" id="summaryGrid">
              <!-- Summary akan diisi oleh JavaScript -->
            </div>
          </div>

          <div class="error-list" id="errorList" style="display: none">
            <!-- Error list akan diisi oleh JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <script>
      // Base URL configuration
      const PROD_API = "https://absensi-db.onrender.com";
      const LOCAL_API = "http://localhost:8080";

      const host = location.hostname;
      const isLocalHost = /^(localhost|127\.0\.0\.1)$/.test(host);
      const isPrivateLAN =
        /^(10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.(1[6-9]|2\d|3[0-1])\.\d+\.\d+)$/.test(
          host
        );

      const BASE_URL =
        (window.BASE_URL && window.BASE_URL.trim()) ||
        (isLocalHost || isPrivateLAN ? LOCAL_API : PROD_API);

      console.log("Using BASE_URL:", BASE_URL);

      // DOM Elements
      const dataTextarea = document.getElementById("dataTextarea");
      const dataInfo = document.getElementById("dataInfo");
      const dataSummary = document.getElementById("dataSummary");
      const validationInfo = document.getElementById("validationInfo");
      const validationText = document.getElementById("validationText");
      const processing = document.getElementById("processing");
      const processingText = document.getElementById("processingText");
      const parseBtn = document.getElementById("parseBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const clearBtn = document.getElementById("clearBtn");
      const resultsSection = document.getElementById("resultsSection");
      const summaryGrid = document.getElementById("summaryGrid");
      const errorList = document.getElementById("errorList");
      const duplicateHandling = document.getElementById("duplicateHandling");

      // Global variables
      let rawData = "";
      let parsedData = [];
      let validationErrors = [];

      function toggleSample() {
        const sampleContent = document.getElementById("sampleContent");
        const toggle = document.querySelector(".sample-toggle");

        if (sampleContent.classList.contains("show")) {
          sampleContent.classList.remove("show");
          toggle.classList.remove("active");
          toggle.querySelector("strong").textContent =
            "🔽 Contoh Data (Klik untuk melihat)";
        } else {
          sampleContent.classList.add("show");
          toggle.classList.add("active");
          toggle.querySelector("strong").textContent =
            "🔼 Contoh Data (Klik untuk sembunyikan)";
        }
      }

      function copySampleData(event) {
        event.stopPropagation();
        const sampleData = `perner	nip	nama	bidang	no_telp
P001	123456	John Doe	IT	+6281355265063
P002	123457	Jane Smith	HR	6281355265064
P003	123458	Bob Johnson	Finance	81355265065
P004	123459	Alice Brown	Marketing	0812-345-6789`;

        navigator.clipboard.writeText(sampleData).then(() => {
          const copyBtn = event.target;
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "✅ Copied!";
          copyBtn.style.color = "#38a169";
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.color = "#667eea";
          }, 2000);
        });
      }

      function handleDataInput() {
        rawData = dataTextarea.value.trim();

        if (rawData.length > 0) {
          parseBtn.disabled = false;

          // Quick analysis
          const lines = rawData.split("\n").filter((line) => line.trim());
          const chars = rawData.length;
          const hasTabSeparator = rawData.includes("\t");
          const hasCommaSeparator = rawData.includes(",");

          let suggestedFormat = "tab";
          if (!hasTabSeparator && hasCommaSeparator) {
            suggestedFormat = "comma";
          }

          // Auto-select format
          if (suggestedFormat === "comma") {
            document.getElementById("formatComma").checked = true;
          } else {
            document.getElementById("formatTab").checked = true;
          }

          dataSummary.innerHTML = `
                    <div class="summary-item">
                        <span class="summary-value">${lines.length}</span> baris
                    </div>
                    <div class="summary-item">
                        <span class="summary-value">${chars.toLocaleString()}</span> karakter
                    </div>
                    <div class="summary-item">
                        Format terdeteksi: <span class="summary-value">${
                          suggestedFormat === "tab"
                            ? "Tab-separated"
                            : "Comma-separated"
                        }</span>
                    </div>
                `;
          dataInfo.classList.add("show");
        } else {
          parseBtn.disabled = true;
          dataInfo.classList.remove("show");
          hideValidation();
        }
      }

      function handleDataPaste() {
        // Small delay to let paste complete
        setTimeout(handleDataInput, 100);
      }

      function parseData() {
        if (!rawData) {
          showValidation("error", "Tidak ada data untuk diparse.");
          return;
        }

        processing.classList.add("show");
        processingText.textContent = "Parsing data...";

        setTimeout(() => {
          try {
            const format = document.querySelector(
              'input[name="dataFormat"]:checked'
            ).value;
            const separator = format === "tab" ? "\t" : ",";

            const lines = rawData.split("\n").filter((line) => line.trim());

            if (lines.length < 2) {
              throw new Error(
                "Data harus memiliki minimal 2 baris (header + data)"
              );
            }

            // Parse headers
            const headers = lines[0]
              .split(separator)
              .map((h) => h.trim().toLowerCase());

            if (headers.length < 4) {
              throw new Error("Header harus memiliki minimal 4 kolom");
            }

            console.log("Headers detected:", headers);

            // Parse data rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(separator).map((v) => v.trim());

              if (
                values.length >= headers.length ||
                values.some((v) => v !== "")
              ) {
                const row = {};
                headers.forEach((header, index) => {
                  row[header] = values[index] || "";
                });
                data.push(row);
              }
            }

            console.log("Parsed data:", data.length, "records");

            if (data.length === 0) {
              throw new Error("Tidak ada data yang dapat diparse");
            }

            if (data.length > 5000) {
              throw new Error(
                `Terlalu banyak data: ${data.length} records. Maksimal 5000 records.`
              );
            }

            processingText.textContent = "Validating data...";
            setTimeout(() => validateData(data), 100);
          } catch (error) {
            processing.classList.remove("show");
            showValidation("error", `Error parsing data: ${error.message}`);
          }
        }, 100);
      }

      function validateData(data) {
        validationErrors = [];
        const requiredFields = ["perner", "nip", "nama", "bidang"];

        // Check headers
        const headers = Object.keys(data[0] || {});
        const missingHeaders = requiredFields.filter(
          (field) =>
            !headers.some((header) => header.toLowerCase().includes(field))
        );

        if (missingHeaders.length > 0) {
          validationErrors.push(
            `Kolom yang hilang: ${missingHeaders.join(", ")}`
          );
        }

        // Validate each row
        const pernerSet = new Set();
        const nipSet = new Set();

        data.forEach((row, index) => {
          const rowNum = index + 1;

          // Get field values flexibly
          const getFieldValue = (row, field) => {
            const keys = Object.keys(row);
            const matchingKey = keys.find((key) =>
              key.toLowerCase().includes(field.toLowerCase())
            );
            return matchingKey ? String(row[matchingKey] || "").trim() : "";
          };

          const perner = getFieldValue(row, "perner");
          const nip = getFieldValue(row, "nip");
          const nama = getFieldValue(row, "nama");
          const bidang = getFieldValue(row, "bidang");
          let no_telp =
            getFieldValue(row, "no_telp") ||
            getFieldValue(row, "phone") ||
            getFieldValue(row, "telp");

          // Check required fields (except no_telp which gets default)
          requiredFields.forEach((field) => {
            const value = getFieldValue(row, field);
            if (!value.trim()) {
              validationErrors.push(`Baris ${rowNum}: ${field} kosong`);
            }
          });

          // Handle phone number with enhanced tolerance for various formats
          if (no_telp.trim()) {
            let cleanPhone = no_telp.trim();

            // Remove all symbols first: -, +, (, ), spaces, dots, etc
            cleanPhone = cleanPhone.replace(/[^\d]/g, "");

            // Now handle different Indonesian phone number formats
            if (cleanPhone.length >= 10) {
              // Handle +6281355265063 -> 6281355265063 (already cleaned above)
              if (cleanPhone.startsWith("62")) {
                // 6281355265063 -> 081355265063
                cleanPhone = "0" + cleanPhone.substring(2);
              }
              // Handle 81355265063 -> 081355265063
              else if (cleanPhone.startsWith("8") && cleanPhone.length >= 10) {
                cleanPhone = "0" + cleanPhone;
              }
              // 081355265063 is already correct format

              // Final validation: must be 08xxxxxxxxx format and reasonable length
              if (
                cleanPhone.startsWith("08") &&
                cleanPhone.length >= 10 &&
                cleanPhone.length <= 15
              ) {
                // Update the row data
                const phoneKey = Object.keys(row).find(
                  (key) =>
                    key.toLowerCase().includes("telp") ||
                    key.toLowerCase().includes("phone")
                );
                if (phoneKey) {
                  row[phoneKey] = cleanPhone;
                }
              } else {
                // Set dash for invalid format after all attempts
                const phoneKey = Object.keys(row).find(
                  (key) =>
                    key.toLowerCase().includes("telp") ||
                    key.toLowerCase().includes("phone")
                );
                if (phoneKey) {
                  row[phoneKey] = "-";
                }
              }
            } else {
              // Too short, set dash
              const phoneKey = Object.keys(row).find(
                (key) =>
                  key.toLowerCase().includes("telp") ||
                  key.toLowerCase().includes("phone")
              );
              if (phoneKey) {
                row[phoneKey] = "-";
              }
            }
          } else {
            // Set dash for empty
            const phoneKey =
              Object.keys(row).find(
                (key) =>
                  key.toLowerCase().includes("telp") ||
                  key.toLowerCase().includes("phone")
              ) || "no_telp";
            row[phoneKey] = "-";
          }

          // Check duplicates
          if (perner) {
            if (pernerSet.has(perner)) {
              validationErrors.push(
                `Baris ${rowNum}: PERNER ${perner} duplikat`
              );
            }
            pernerSet.add(perner);
          }

          if (nip) {
            if (nipSet.has(nip)) {
              validationErrors.push(`Baris ${rowNum}: NIP ${nip} duplikat`);
            }
            nipSet.add(nip);
          }

          // Check field lengths
          if (perner && perner.length > 50) {
            validationErrors.push(
              `Baris ${rowNum}: PERNER terlalu panjang (max 50)`
            );
          }
          if (nip && nip.length > 50) {
            validationErrors.push(
              `Baris ${rowNum}: NIP terlalu panjang (max 50)`
            );
          }
          if (nama && nama.length > 100) {
            validationErrors.push(
              `Baris ${rowNum}: Nama terlalu panjang (max 100)`
            );
          }
          if (bidang && bidang.length > 100) {
            validationErrors.push(
              `Baris ${rowNum}: Bidang terlalu panjang (max 100)`
            );
          }
        });

        processing.classList.remove("show");

        if (validationErrors.length > 0) {
          const errorCount = validationErrors.length;
          const maxShow = 10;
          let errorMessage = `Ditemukan ${errorCount} error:<br>`;
          errorMessage += validationErrors.slice(0, maxShow).join("<br>");
          if (errorCount > maxShow) {
            errorMessage += `<br>... dan ${errorCount - maxShow} error lainnya`;
          }
          showValidation("error", errorMessage);
          uploadBtn.disabled = true;
        } else {
          parsedData = data;
          showValidation(
            "success",
            `✅ Data valid! ${data.length} records siap untuk diupload.`
          );
          duplicateHandling.style.display = "block"; // Show duplicate handling options
          uploadBtn.disabled = false;
        }
      }

      async function processUpload() {
        if (
          !parsedData ||
          parsedData.length === 0 ||
          validationErrors.length > 0
        ) {
          showValidation("error", "Tidak ada data valid untuk diupload.");
          return;
        }

        // Get selected duplicate handling option
        const duplicateAction = document.querySelector(
          'input[name="duplicateAction"]:checked'
        ).value;

        processing.classList.add("show");
        processingText.textContent = "Mengupload ke database...";

        try {
          const response = await fetch(
            `${BASE_URL}/api/data_pegawai/bulk_upload`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                data: parsedData,
                filename: "pasted_data.txt",
                total_records: parsedData.length,
                duplicate_action: duplicateAction, // Add duplicate handling option
              }),
            }
          );

          const result = await response.json();

          processing.classList.remove("show");

          if (result.success) {
            showResults(result);
            showValidation(
              "success",
              `✅ Upload berhasil! ${result.data.successful_inserts} records berhasil disimpan.`
            );
          } else {
            showValidation("error", `❌ Upload gagal: ${result.message}`);
          }
        } catch (error) {
          processing.classList.remove("show");
          showValidation("error", `❌ Error saat upload: ${error.message}`);
        }
      }

      function showResults(result) {
        const data = result.data;

        summaryGrid.innerHTML = `
                <div class="summary-item-large">
                    <div class="summary-value-large">${
                      data.total_records || 0
                    }</div>
                    <div class="summary-label">Total Records</div>
                </div>
                <div class="summary-item-large">
                    <div class="summary-value-large" style="color: #38a169;">${
                      data.successful_inserts || 0
                    }</div>
                    <div class="summary-label">Berhasil</div>
                </div>
                <div class="summary-item-large">
                    <div class="summary-value-large" style="color: #e53e3e;">${
                      data.failed_inserts || 0
                    }</div>
                    <div class="summary-label">Gagal</div>
                </div>
                <div class="summary-item-large">
                    <div class="summary-value-large" style="color: #667eea;">${
                      data.updated_records || 0
                    }</div>
                    <div class="summary-label">Diupdate</div>
                </div>
                <div class="summary-item-large">
                    <div class="summary-value-large">${Math.round(
                      (data.successful_inserts / data.total_records) * 100
                    )}%</div>
                    <div class="summary-label">Success Rate</div>
                </div>
            `;

        if (data.errors && data.errors.length > 0) {
          errorList.style.display = "block";
          errorList.innerHTML = data.errors
            .map(
              (error) => `
                    <div class="error-item">
                        <div class="error-row">Row ${
                          error.row || "Unknown"
                        }</div>
                        <div class="error-message">${
                          error.message || error
                        }</div>
                    </div>
                `
            )
            .join("");
        }

        resultsSection.classList.add("show");
      }

      function showValidation(type, message) {
        validationInfo.className = `validation-info show ${type}`;
        validationText.innerHTML = message;
      }

      function hideValidation() {
        validationInfo.classList.remove("show");
      }

      function clearAll() {
        rawData = "";
        parsedData = [];
        validationErrors = [];

        dataTextarea.value = "";
        dataInfo.classList.remove("show");
        validationInfo.classList.remove("show");
        processing.classList.remove("show");
        resultsSection.classList.remove("show");
        duplicateHandling.style.display = "none"; // Hide duplicate handling options

        parseBtn.disabled = true;
        uploadBtn.disabled = true;
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Upload Data Pegawai (Paste Version) page initialized");
        console.log("Using BASE_URL:", BASE_URL);
      });
    </script>
  </body>
</html>

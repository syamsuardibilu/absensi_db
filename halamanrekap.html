<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Rekap Absensi Karyawan</title>

    <!-- SheetJS Library untuk Export Excel XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 10px;
      }

      .header p {
        color: #7f8c8d;
        text-align: center;
        font-size: 1.1rem;
      }

      .controls {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(17, 153, 142, 0.6);
      }

      .btn-download {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
      }

      .btn-download:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .search-box {
        flex: 1;
        min-width: 250px;
      }

      .search-box input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
      }

      .search-box input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .stats {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        display: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-card h3 {
        font-size: 0.9rem;
        margin-bottom: 8px;
        opacity: 0.9;
      }

      .stat-card p {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .table-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
      }

      .table-scroll-wrapper {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 600px;
        position: relative;
        /* Custom scrollbar */
        scrollbar-width: thin;
        scrollbar-color: #667eea #f1f1f1;

        /* --- Offset untuk sticky multi-row header (akan di-set via JS) --- */
        --header-row-1: 0px;
        --header-row-2: 40px;
      }

      .table-scroll-wrapper::-webkit-scrollbar {
        height: 12px;
        width: 12px;
      }

      .table-scroll-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
      }

      .table-scroll-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
      }

      .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      }

      /* Scroll indicator */
      .scroll-indicator {
        position: absolute;
        top: 10px;
        right: 20px;
        background: rgba(102, 126, 234, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 150;
        animation: fadeInOut 3s ease-in-out;
      }

      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        min-width: 1800px;
      }

      th,
      td {
        border: 1px solid #e1e8ed;
        padding: 12px 8px;
        text-align: center;
        white-space: nowrap;
      }

      /* --- Sticky header baru: hanya thead th yang sticky --- */
      thead th {
        position: sticky;
        z-index: 100; /* di atas body cells */
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        font-weight: 600;
        font-size: 10px;
      }

      /* Baris header utama (judul grup) */
      thead tr.main-header th {
        top: var(--header-row-1);
        z-index: 102; /* di atas subheader */
        /* warna berbeda agar jelas */
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        font-size: 9px;
        padding: 8px 4px;
      }

      /* Baris subheader (judul kolom) */
      thead tr.sub-header th {
        top: calc(var(--header-row-1) + var(--header-row-2));
        z-index: 101;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      tbody tr:nth-child(even) {
        background: rgba(102, 126, 234, 0.05);
      }

      tbody tr:hover {
        background: rgba(102, 126, 234, 0.15);
        transform: scale(1.001);
        transition: all 0.2s ease;
      }

      /* Kolom PERNER sticky kiri tanpa menutupi header */
      .perner {
        font-weight: 700;
        background: rgba(102, 126, 234, 0.2);
        position: sticky;
        left: 0;
        z-index: 90; /* lebih rendah dari header (101/102) */
      }

      .percentage {
        font-weight: 600;
      }

      .percentage.high {
        color: #27ae60;
        background: rgba(39, 174, 96, 0.1);
        border-radius: 6px;
      }

      .percentage.medium {
        color: #f39c12;
        background: rgba(243, 156, 18, 0.1);
        border-radius: 6px;
      }

      .percentage.low {
        color: #e74c3c;
        background: rgba(231, 76, 60, 0.1);
        border-radius: 6px;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .alert-success {
        background: rgba(39, 174, 96, 0.1);
        color: #27ae60;
        border: 2px solid rgba(39, 174, 96, 0.2);
      }

      .alert-error {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
        border: 2px solid rgba(231, 76, 60, 0.2);
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        margin-top: 15px;
        border-radius: 12px;
      }

      .pagination button {
        padding: 8px 16px;
        border: 2px solid #e1e8ed;
        background: white;
        color: #2c3e50;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .pagination button:hover:not(:disabled) {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination .active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #7f8c8d;
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
      }

      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .search-box {
          min-width: auto;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Header -->
      <div class="header">
        <h1>📊 Dashboard Rekap Absensi</h1>
        <p>Sistem Monitoring dan Analisis Kehadiran Karyawan</p>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button id="generateBtn" class="btn btn-primary">
          <span>⚡</span> Generate Rekap Absensi
        </button>
        <button id="refreshBtn" class="btn btn-secondary">
          <span>🔄</span> Refresh Data
        </button>
        <button id="downloadBtn" class="btn btn-download" disabled>
          <span>📊</span> Download Excel (.xlsx)
        </button>
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="🔍 Cari berdasarkan PERNER..."
          />
        </div>
      </div>

      <!-- Alert Messages -->
      <div id="alertContainer"></div>

      <!-- Statistics -->
      <div id="statsContainer" class="stats">
        <div class="stats-grid" id="statsGrid">
          <!-- Stats akan di-generate oleh JavaScript -->
        </div>
      </div>

      <!-- Loading -->
      <div id="loadingContainer" class="loading">
        <div class="loading-spinner"></div>
        <div>Memproses data...</div>
      </div>

      <!-- Table -->
      <div class="table-container" id="tableContainer">
        <div
          class="scroll-indicator"
          id="scrollIndicator"
          style="display: none"
        >
          ← Scroll untuk melihat kolom lainnya →
        </div>
        <div class="table-scroll-wrapper" id="tableScrollWrapper">
          <div class="no-data" id="noDataMessage">
            📋 Belum ada data rekap. Klik tombol "Generate Rekap Absensi" untuk
            memulai.
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div id="paginationContainer" class="pagination" style="display: none">
        <!-- Pagination akan di-generate oleh JavaScript -->
      </div>
    </div>

    <script>
      const BASE_URL =
        (window.BASE_URL && window.BASE_URL.trim()) || window.location.origin;

      // Helper fetch: aman jika path tanpa "/" di depan.
      const api = (path, opts) => {
        const p = path.startsWith("/") ? path : `/${path}`;
        return fetch(`${BASE_URL}${p}`, opts);
      };
      // === END KONFIG ===

      // Untuk backward compatibility
      const API_BASE_URL = BASE_URL;

      console.log("🔧 BASE_URL:", BASE_URL);
      console.log("🔧 API Base URL:", API_BASE_URL);
      console.log("🌐 Current hostname:", location.hostname);
      console.log("🌐 Current page URL:", window.location.href);
      console.log(
        "🎯 Environment:",
        location.hostname.includes("onrender.com")
          ? "PRODUCTION"
          : "DEVELOPMENT"
      );

      // Global variables
      let currentPage = 1;
      let itemsPerPage = 50;
      let totalPages = 1;
      let searchQuery = "";
      let currentData = []; // Store current data for export

      // DOM Elements
      const generateBtn = document.getElementById("generateBtn");
      const refreshBtn = document.getElementById("refreshBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const searchInput = document.getElementById("searchInput");
      const alertContainer = document.getElementById("alertContainer");
      const statsContainer = document.getElementById("statsContainer");
      const loadingContainer = document.getElementById("loadingContainer");
      const tableContainer = document.getElementById("tableContainer");
      const tableScrollWrapper = document.getElementById("tableScrollWrapper");
      const scrollIndicator = document.getElementById("scrollIndicator");
      const paginationContainer = document.getElementById(
        "paginationContainer"
      );
      const noDataMessage = document.getElementById("noDataMessage");

      // Event Listeners
      generateBtn.addEventListener("click", generateRekap);
      refreshBtn.addEventListener("click", loadRekapData);
      downloadBtn.addEventListener("click", downloadExcel);
      searchInput.addEventListener("input", debounce(handleSearch, 500));

      // Download Excel Function (.xlsx format with merged headers)
      async function downloadExcel() {
        try {
          if (!currentData || currentData.length === 0) {
            showAlert(
              "❌ Tidak ada data untuk diunduh. Generate rekap terlebih dahulu.",
              "error"
            );
            return;
          }

          showLoading(true);
          showAlert("📊 Mengunduh data dalam format Excel (.xlsx)...", "info");

          // Get all data (not just current page) for export
          const allDataResponse = await fetch(
            `${API_BASE_URL}/get-rekap-absensi?limit=10000&offset=0&search=${encodeURIComponent(
              searchQuery
            )}`
          );
          const allDataResult = await allDataResponse.json();

          if (!allDataResult.success) {
            throw new Error("Gagal mengambil data lengkap");
          }

          const data = allDataResult.data;
          console.log(`📊 Exporting ${data.length} records to Excel (.xlsx)`);

          // Create workbook
          const wb = XLSX.utils.book_new();

          // Create worksheet data manually with merged headers
          const ws = {};

          // Set worksheet range
          const totalRows = data.length + 2; // +2 for header rows
          const totalCols = 26; // Total columns
          ws["!ref"] = XLSX.utils.encode_range({
            s: { c: 0, r: 0 },
            e: { c: totalCols - 1, r: totalRows - 1 },
          });

          // Row 1: Main headers (merged)
          const mainHeaders = [
            { value: "PERNER", col: 0 },
            { value: "JUMLAH HARI", col: 1, span: 3 },
            { value: "DATA KOREKSI", col: 4, span: 4 },
            { value: "POLA JAM KERJA NORMAL", col: 8, span: 4 },
            { value: "POLA JAM KERJA SHIFT", col: 12, span: 5 },
            { value: "KETERANGAN ABSEN MASUK DAN PULANG", col: 17, span: 4 },
            { value: "PENGAJUAN KETIDAKHADIRAN", col: 21, span: 2 },
            { value: "PEROLEHAN DURASI JAM KERJA", col: 23, span: 3 },
          ];

          // Row 2: Sub headers
          const subHeaders = [
            "PERNER",
            "TOTAL HARI",
            "HARI KERJA",
            "HARI LIBUR",
            "TOTAL HARI KOREKSI",
            "KOREKSI IN",
            "KOREKSI OUT",
            "KOREKSI IN & OUT",
            "TOTAL JAM KERJA NORMAL",
            "PIKET",
            "PDKB",
            "REGULER",
            "TOTAL JAM KERJA SHIFT",
            "SHIFT PAGI",
            "SHIFT SIANG",
            "SHIFT MALAM",
            "SHIFT OFF",
            "ABSEN LENGKAP",
            "TIDAK ABSEN",
            "IN KOSONG",
            "OUT KOSONG",
            "SPPD/TUGAS LUAR DLL",
            "CUTI/IJIN",
            "JAM REALISASI",
            "JAM SEHARUSNYA",
            "PERSENTASE JKP (%)",
          ];

          // Create main headers (row 0)
          mainHeaders.forEach((header) => {
            const cellRef = XLSX.utils.encode_cell({ r: 0, c: header.col });
            ws[cellRef] = {
              v: header.value,
              t: "s",
              s: {
                font: { bold: true, color: { rgb: "FFFFFF" }, size: 11 },
                fill: { fgColor: { rgb: "2196F3" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "FFFFFF" } },
                  bottom: { style: "thin", color: { rgb: "FFFFFF" } },
                  left: { style: "thin", color: { rgb: "FFFFFF" } },
                  right: { style: "thin", color: { rgb: "FFFFFF" } },
                },
              },
            };
          });

          // Create sub headers (row 1)
          subHeaders.forEach((header, index) => {
            const cellRef = XLSX.utils.encode_cell({ r: 1, c: index });
            ws[cellRef] = {
              v: header,
              t: "s",
              s: {
                font: { bold: true, color: { rgb: "FFFFFF" }, size: 10 },
                fill: { fgColor: { rgb: "11998E" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "FFFFFF" } },
                  bottom: { style: "thin", color: { rgb: "FFFFFF" } },
                  left: { style: "thin", color: { rgb: "FFFFFF" } },
                  right: { style: "thin", color: { rgb: "FFFFFF" } },
                },
              },
            };
          });

          // Add data rows (starting from row 2)
          data.forEach((row, rowIndex) => {
            const dataRow = [
              row.PERNER,
              parseInt(row.TOTAL_HARI),
              parseInt(row.HARI_KERJA),
              parseInt(row.HARI_LIBUR),
              parseInt(row.TOTAL_HARI_KOREKSI),
              parseInt(row.KOREKSI_IN),
              parseInt(row.KOREKSI_OUT),
              parseInt(row.KOREKSI_IN_OUT),
              parseInt(row.TOTAL_JAM_KERJA_NORMAL),
              parseInt(row.PIKET),
              parseInt(row.PDKB),
              parseInt(row.REGULER),
              parseInt(row.TOTAL_JAM_KERJA_SHIFT),
              parseInt(row.SHIFT_PAGI),
              parseInt(row.SHIFT_SIANG),
              parseInt(row.SHIFT_MALAM),
              parseInt(row.SHIFT_OFF),
              parseInt(row.ABSEN_LENGKAP),
              parseInt(row.TIDAK_ABSEN),
              parseInt(row.IN_KOSONG),
              parseInt(row.OUT_KOSONG),
              parseInt(row.SPPD_TUGAS_LUAR_DLL),
              parseInt(row.CUTI_IJIN),
              parseFloat(row.JAM_REALISASI),
              parseFloat(row.JAM_SEHARUSNYA),
              parseFloat(row.PERSENTASE_JKP),
            ];

            dataRow.forEach((cellValue, colIndex) => {
              const cellRef = XLSX.utils.encode_cell({
                r: rowIndex + 2,
                c: colIndex,
              });
              let cellStyle = {
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "CCCCCC" } },
                  bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                  left: { style: "thin", color: { rgb: "CCCCCC" } },
                  right: { style: "thin", color: { rgb: "CCCCCC" } },
                },
              };

              // Special formatting for specific columns
              if (colIndex === 0) {
                // PERNER column
                cellStyle.font = { bold: true };
                cellStyle.fill = { fgColor: { rgb: "E3F2FD" } };
              } else if (colIndex >= 23 && colIndex <= 24) {
                // JAM REALISASI & JAM SEHARUSNYA
                cellStyle.numFmt = "#,##0.00";
              } else if (colIndex === 25) {
                // PERSENTASE JKP
                cellStyle.numFmt = "#,##0.00";

                // Color coding for percentage
                const value = parseFloat(cellValue);
                if (value >= 90) {
                  cellStyle.fill = { fgColor: { rgb: "E8F5E8" } };
                  cellStyle.font = { color: { rgb: "2E7D32" } };
                } else if (value >= 70) {
                  cellStyle.fill = { fgColor: { rgb: "FFF3E0" } };
                  cellStyle.font = { color: { rgb: "F57C00" } };
                } else {
                  cellStyle.fill = { fgColor: { rgb: "FFEBEE" } };
                  cellStyle.font = { color: { rgb: "C62828" } };
                }
              }

              ws[cellRef] = {
                v: cellValue,
                t: typeof cellValue === "number" ? "n" : "s",
                s: cellStyle,
              };
            });
          });

          // Set merge ranges for main headers
          const merges = [
            { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } }, // PERNER (span 2 rows)
            { s: { r: 0, c: 1 }, e: { r: 0, c: 3 } }, // JUMLAH HARI
            { s: { r: 0, c: 4 }, e: { r: 0, c: 7 } }, // DATA KOREKSI
            { s: { r: 0, c: 8 }, e: { r: 0, c: 11 } }, // POLA JAM KERJA NORMAL
            { s: { r: 0, c: 12 }, e: { r: 0, c: 16 } }, // POLA JAM KERJA SHIFT
            { s: { r: 0, c: 17 }, e: { r: 0, c: 20 } }, // KETERANGAN ABSEN MASUK DAN PULANG
            { s: { r: 0, c: 21 }, e: { r: 0, c: 22 } }, // PENGAJUAN KETIDAKHADIRAN
            { s: { r: 0, c: 23 }, e: { r: 0, c: 25 } }, // PEROLEHAN DURASI JAM KERJA
          ];
          ws["!merges"] = merges;

          // Set column widths for better readability
          const colWidths = [
            { wch: 12 }, // PERNER
            { wch: 10 }, // TOTAL HARI
            { wch: 10 }, // HARI KERJA
            { wch: 10 }, // HARI LIBUR
            { wch: 12 }, // TOTAL HARI KOREKSI
            { wch: 10 }, // KOREKSI IN
            { wch: 10 }, // KOREKSI OUT
            { wch: 12 }, // KOREKSI IN & OUT
            { wch: 15 }, // TOTAL JAM KERJA NORMAL
            { wch: 8 }, // PIKET
            { wch: 8 }, // PDKB
            { wch: 10 }, // REGULER
            { wch: 15 }, // TOTAL JAM KERJA SHIFT
            { wch: 10 }, // SHIFT PAGI
            { wch: 10 }, // SHIFT SIANG
            { wch: 10 }, // SHIFT MALAM
            { wch: 10 }, // SHIFT OFF
            { wch: 12 }, // ABSEN LENGKAP
            { wch: 10 }, // TIDAK ABSEN
            { wch: 10 }, // IN KOSONG
            { wch: 10 }, // OUT KOSONG
            { wch: 15 }, // SPPD/TUGAS LUAR DLL
            { wch: 10 }, // CUTI/IJIN
            { wch: 12 }, // JAM REALISASI
            { wch: 12 }, // JAM SEHARUSNYA
            { wch: 12 }, // PERSENTASE JKP
          ];
          ws["!cols"] = colWidths;

          // Set row heights for headers
          ws["!rows"] = [
            { hpt: 25 }, // Row 0 height
            { hpt: 20 }, // Row 1 height
          ];

          // Add worksheet to workbook
          XLSX.utils.book_append_sheet(wb, ws, "Rekap Absensi");

          // Generate filename
          const timestamp = new Date().toISOString().split("T")[0];
          const filename = `Rekap_Absensi_${timestamp}${
            searchQuery ? "_Filtered" : ""
          }.xlsx`;

          // Write and download file
          XLSX.writeFile(wb, filename);

          showAlert(
            `✅ File "${filename}" berhasil diunduh! (${data.length} records)`,
            "success"
          );
        } catch (error) {
          console.error("Download error:", error);
          let errorMessage = "❌ Gagal mengunduh file: ";

          if (error.message.includes("XLSX is not defined")) {
            errorMessage +=
              "Library Excel tidak tersedia. Refresh halaman dan coba lagi.";
          } else {
            errorMessage += error.message;
          }

          showAlert(errorMessage, "error");
        } finally {
          showLoading(false);
        }
      }

      // Generate Rekap Function
      async function generateRekap() {
        try {
          showLoading(true);
          showAlert("🔄 Memulai proses generate rekap absensi...", "info");

          generateBtn.disabled = true;
          refreshBtn.disabled = true;

          console.log("🚀 Generate rekap started...");
          console.log("🔗 POST URL:", `${API_BASE_URL}/generate-rekap-absensi`);

          const response = await fetch(
            `${API_BASE_URL}/generate-rekap-absensi`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              mode: "cors", // Explicit CORS mode
            }
          );

          console.log("📡 Response status:", response.status);
          console.log("📡 Response headers:", [...response.headers.entries()]);

          if (!response.ok) {
            const errorText = await response.text();
            console.error("❌ Server response error:", errorText);
            throw new Error(
              `HTTP Error: ${response.status} - ${
                response.statusText
              }\nResponse: ${errorText.substring(0, 200)}`
            );
          }

          const contentType = response.headers.get("content-type");
          console.log("📄 Content-Type:", contentType);

          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            console.error("❌ Non-JSON response:", text);
            throw new Error(
              `Server mengembalikan response non-JSON: ${text.substring(
                0,
                200
              )}...`
            );
          }

          const result = await response.json();
          console.log("✅ Generate result:", result);

          if (result.success) {
            showAlert(`✅ ${result.message}`, "success");
            if (result.stats) {
              displayStats(result.stats);
            }
            await loadRekapData();
          } else {
            showAlert(
              `❌ ${result.message || "Generate rekap gagal"}`,
              "error"
            );
          }
        } catch (error) {
          console.error("❌ Generate rekap error:", error);

          // Better error messages
          let errorMessage = "❌ Terjadi kesalahan: ";
          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("NetworkError")
          ) {
            errorMessage += `Server tidak dapat diakses. Pastikan server sudah berjalan di ${API_BASE_URL}.`;
          } else if (error.message.includes("404")) {
            errorMessage +=
              "Endpoint tidak ditemukan. Periksa apakah server sudah running dengan benar.";
          } else if (error.message.includes("405")) {
            errorMessage +=
              "Method tidak diizinkan. Periksa server routing dan CORS configuration.";
          } else if (error.message.includes("500")) {
            errorMessage +=
              "Kesalahan server internal. Periksa database connection dan console server.";
          } else {
            errorMessage += error.message;
          }

          showAlert(errorMessage, "error");
        } finally {
          showLoading(false);
          generateBtn.disabled = false;
          refreshBtn.disabled = false;
        }
      }

      // Load Rekap Data Function
      async function loadRekapData() {
        try {
          showLoading(true);

          const offset = (currentPage - 1) * itemsPerPage;
          const url = `${API_BASE_URL}/get-rekap-absensi?limit=${itemsPerPage}&offset=${offset}&search=${encodeURIComponent(
            searchQuery
          )}`;

          console.log("🔗 API Request URL:", url);
          console.log("🔗 API Base URL:", API_BASE_URL);

          const response = await fetch(url);
          const result = await response.json();

          if (result.success) {
            displayRekapData(result.data);
            displayPagination(result.pagination);

            if (result.data.length > 0) {
              noDataMessage.style.display = "none";
              statsContainer.style.display = "block";
              downloadBtn.disabled = false;
            } else {
              noDataMessage.style.display = "block";
              downloadBtn.disabled = true;
              noDataMessage.innerHTML = searchQuery
                ? "🔍 Tidak ada data yang sesuai dengan pencarian."
                : '📋 Belum ada data rekap. Klik tombol "Generate Rekap Absensi" untuk memulai.';
            }
          } else {
            showAlert(`❌ ${result.message}`, "error");
          }
        } catch (error) {
          console.error("Error loading data:", error);
          showAlert("❌ Terjadi kesalahan saat memuat data.", "error");
        } finally {
          showLoading(false);
        }
      }

      // Display Rekap Data in Table
      function displayRekapData(data) {
        if (!data || data.length === 0) {
          tableScrollWrapper.innerHTML = `<div class="no-data">📋 Tidak ada data untuk ditampilkan.</div>`;
          downloadBtn.disabled = true;
          return;
        }

        // Store current data for export
        currentData = data;
        downloadBtn.disabled = false;

        const table = `
          <table>
            <thead>
              <tr class="main-header">
                <th rowspan="2">PERNER</th>
                <th colspan="3">JUMLAH HARI</th>
                <th colspan="4">DATA KOREKSI</th>
                <th colspan="4">POLA JAM KERJA NORMAL</th>
                <th colspan="5">POLA JAM KERJA SHIFT</th>
                <th colspan="4">KETERANGAN ABSEN MASUK DAN PULANG</th>
                <th colspan="2">PENGAJUAN KETIDAKHADIRAN</th>
                <th colspan="3">PEROLEHAN DURASI JAM KERJA</th>
              </tr>
              <tr class="sub-header">
                <th>TOTAL HARI</th>
                <th>HARI KERJA</th>
                <th>HARI LIBUR</th>
                <th>TOTAL HARI KOREKSI</th>
                <th>KOREKSI IN</th>
                <th>KOREKSI OUT</th>
                <th>KOREKSI IN & OUT</th>
                <th>TOTAL JAM KERJA NORMAL</th>
                <th>PIKET</th>
                <th>PDKB</th>
                <th>REGULER</th>
                <th>TOTAL JAM KERJA SHIFT</th>
                <th>SHIFT PAGI</th>
                <th>SHIFT SIANG</th>
                <th>SHIFT MALAM</th>
                <th>SHIFT OFF</th>
                <th>ABSEN LENGKAP</th>
                <th>TIDAK ABSEN</th>
                <th>IN KOSONG</th>
                <th>OUT KOSONG</th>
                <th>SPPD/TUGAS LUAR DLL</th>
                <th>CUTI/IJIN</th>
                <th>JAM REALISASI</th>
                <th>JAM SEHARUSNYA</th>
                <th>PERSENTASE JKP (%)</th>
              </tr>
            </thead>
            <tbody>
              ${data
                .map(
                  (row) => `
                  <tr>
                    <td class="perner">${row.PERNER}</td>
                    <td>${row.TOTAL_HARI}</td>
                    <td>${row.HARI_KERJA}</td>
                    <td>${row.HARI_LIBUR}</td>
                    <td>${row.TOTAL_HARI_KOREKSI}</td>
                    <td>${row.KOREKSI_IN}</td>
                    <td>${row.KOREKSI_OUT}</td>
                    <td>${row.KOREKSI_IN_OUT}</td>
                    <td>${row.TOTAL_JAM_KERJA_NORMAL}</td>
                    <td>${row.PIKET}</td>
                    <td>${row.PDKB}</td>
                    <td>${row.REGULER}</td>
                    <td>${row.TOTAL_JAM_KERJA_SHIFT}</td>
                    <td>${row.SHIFT_PAGI}</td>
                    <td>${row.SHIFT_SIANG}</td>
                    <td>${row.SHIFT_MALAM}</td>
                    <td>${row.SHIFT_OFF}</td>
                    <td>${row.ABSEN_LENGKAP}</td>
                    <td>${row.TIDAK_ABSEN}</td>
                    <td>${row.IN_KOSONG}</td>
                    <td>${row.OUT_KOSONG}</td>
                    <td>${row.SPPD_TUGAS_LUAR_DLL}</td>
                    <td>${row.CUTI_IJIN}</td>
                    <td>${parseFloat(row.JAM_REALISASI).toFixed(2)}</td>
                    <td>${parseFloat(row.JAM_SEHARUSNYA).toFixed(2)}</td>
                    <td class="percentage ${getPercentageClass(
                      row.PERSENTASE_JKP
                    )}">${parseFloat(row.PERSENTASE_JKP).toFixed(2)}</td>
                  </tr>
                `
                )
                .join("")}
            </tbody>
          </table>
        `;

        tableScrollWrapper.innerHTML = table;

        // Hitung tinggi baris header agar offset sticky akurat di semua device
        const mainHeaderRow = tableScrollWrapper.querySelector(
          "thead tr.main-header"
        );
        const subHeaderRow = tableScrollWrapper.querySelector(
          "thead tr.sub-header"
        );

        if (mainHeaderRow && subHeaderRow) {
          // Pakai getBoundingClientRect untuk tinggi aktual
          const h1 = Math.ceil(mainHeaderRow.getBoundingClientRect().height);
          const h2 = Math.ceil(subHeaderRow.getBoundingClientRect().height);
          tableScrollWrapper.style.setProperty("--header-row-1", `${0}px`);
          tableScrollWrapper.style.setProperty("--header-row-2", `${h1}px`);
          // Subheader akan ditempatkan di bawah main header via top: var(--header-row-1)+var(--header-row-2)
        }

        // Show scroll indicator for wide tables
        showScrollIndicator();

        // Add scroll event listener to hide indicator after user scrolls
        tableScrollWrapper.addEventListener("scroll", () => {
          scrollIndicator.style.display = "none";
        });
      }

      // Get percentage class for styling
      function getPercentageClass(percentage) {
        const pct = parseFloat(percentage);
        if (pct >= 90) return "high";
        if (pct >= 70) return "medium";
        return "low";
      }

      // Display Statistics
      function displayStats(stats) {
        const statsGrid = document.getElementById("statsGrid");
        statsGrid.innerHTML = `
          <div class="stat-card">
            <h3>Total Pegawai</h3>
            <p>${stats.total_pegawai || 0}</p>
          </div>
          <div class="stat-card">
            <h3>Rata-rata JKP</h3>
            <p>${stats.avg_persentase || 0}%</p>
          </div>
          <div class="stat-card">
            <h3>Total Jam Realisasi</h3>
            <p>${parseFloat(stats.total_jam_realisasi || 0).toFixed(1)}</p>
          </div>
          <div class="stat-card">
            <h3>Total Jam Seharusnya</h3>
            <p>${parseFloat(stats.total_jam_seharusnya || 0).toFixed(1)}</p>
          </div>
        `;
        statsContainer.style.display = "block";
      }

      // Display Pagination
      function displayPagination(pagination) {
        if (!pagination || pagination.totalPages <= 1) {
          paginationContainer.style.display = "none";
          return;
        }

        totalPages = pagination.totalPages;
        currentPage = Math.floor(pagination.offset / pagination.limit) + 1;

        let paginationHTML = `
          <button onclick="goToPage(1)" ${
            currentPage === 1 ? "disabled" : ""
          }>««</button>
          <button onclick="goToPage(${currentPage - 1})" ${
          currentPage === 1 ? "disabled" : ""
        }>‹</button>
        `;

        // Show page numbers (simplified)
        for (
          let i = Math.max(1, currentPage - 2);
          i <= Math.min(totalPages, currentPage + 2);
          i++
        ) {
          paginationHTML += `
            <button onclick="goToPage(${i})" class="${
            i === currentPage ? "active" : ""
          }">${i}</button>
          `;
        }

        paginationHTML += `
          <button onclick="goToPage(${currentPage + 1})" ${
          currentPage === totalPages ? "disabled" : ""
        }>›</button>
          <button onclick="goToPage(${totalPages})" ${
          currentPage === totalPages ? "disabled" : ""
        }>»»</button>
        `;

        paginationContainer.innerHTML = paginationHTML;
        paginationContainer.style.display = "flex";
      }

      // Go to specific page
      function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        currentPage = page;
        loadRekapData();
      }

      // Handle search
      function handleSearch() {
        searchQuery = searchInput.value.trim();
        currentPage = 1;
        loadRekapData();
      }

      // Show loading state
      function showLoading(show) {
        loadingContainer.style.display = show ? "block" : "none";
      }

      // Show alert messages
      function showAlert(message, type) {
        const alertClass =
          type === "success"
            ? "alert-success"
            : type === "error"
            ? "alert-error"
            : "alert-info";

        const alertHTML = `<div class="alert ${alertClass}">${message}</div>`;
        alertContainer.innerHTML = alertHTML;

        // Auto hide after 5 seconds
        setTimeout(() => {
          alertContainer.innerHTML = "";
        }, 5000);
      }

      // Debounce function
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Show scroll indicator
      function showScrollIndicator() {
        // Only show if table is wider than container
        const table = tableScrollWrapper.querySelector("table");
        if (table && table.scrollWidth > tableScrollWrapper.clientWidth) {
          scrollIndicator.style.display = "block";
          // Auto hide after 3 seconds
          setTimeout(() => {
            scrollIndicator.style.display = "none";
          }, 3000);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadRekapData();
      });
    </script>
    <script src="script.js?v=20250812"></script>
  </body>
</html>
